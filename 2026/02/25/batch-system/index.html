

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/xiu.jpg">
  <link rel="icon" href="/img/xiu.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#647FBC">
  <meta name="author" content="roxy">
  <meta name="keywords" content="">
  
    <meta name="description" content="batch systemintroductionè¿™æ˜¯hello kernelçš„åç»­ ä¸Šä¸€ç¯‡æˆ‘ä»¬å®ç°äº†æ‰“å°hello kernelï¼Œç°åœ¨æˆ‘ä»¬ç»§ç»­è¿­ä»£ å…ˆä»‹ç»ä¸€ä¸‹å†å² åœ¨è®¡ç®—æœºåˆšåˆšè¯ç”Ÿçš„å¹´ä»£ï¼Œå¾ˆå¤šäº‹æƒ…å¹¶ä¸åƒæˆ‘ä»¬æƒ³è±¡çš„é‚£ä¹ˆç®€å• å½“æ—¶ï¼Œç¨‹åºè¢«è®°å½•åœ¨æ‰“å­”çš„å¡ç‰‡ä¸Šï¼Œä½¿ç”¨æ±‡ç¼–è¯­è¨€ç”šè‡³æœºå™¨è¯­è¨€æ¥ç¼–å†™(???) è€Œç¨€ç¼ºä¸”æ˜‚è´µçš„è®¡ç®—æœºç”±ä¸“ä¸šçš„ç®¡ç†å‘˜è´Ÿè´£æ“ä½œï¼Œå°±å’Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç« æ‰€åšçš„äº‹æƒ…ä¸€æ ·ï¼Œä»–ä»¬æ‰‹åŠ¨å°†å¡ç‰‡è¾“å…¥è®¡ç®—æœºï¼Œç­‰">
<meta property="og:type" content="article">
<meta property="og:title" content="batch system">
<meta property="og:url" content="https://roxy5201314.github.io/2026/02/25/batch-system/index.html">
<meta property="og:site_name" content="roxy&#39;s blog">
<meta property="og:description" content="batch systemintroductionè¿™æ˜¯hello kernelçš„åç»­ ä¸Šä¸€ç¯‡æˆ‘ä»¬å®ç°äº†æ‰“å°hello kernelï¼Œç°åœ¨æˆ‘ä»¬ç»§ç»­è¿­ä»£ å…ˆä»‹ç»ä¸€ä¸‹å†å² åœ¨è®¡ç®—æœºåˆšåˆšè¯ç”Ÿçš„å¹´ä»£ï¼Œå¾ˆå¤šäº‹æƒ…å¹¶ä¸åƒæˆ‘ä»¬æƒ³è±¡çš„é‚£ä¹ˆç®€å• å½“æ—¶ï¼Œç¨‹åºè¢«è®°å½•åœ¨æ‰“å­”çš„å¡ç‰‡ä¸Šï¼Œä½¿ç”¨æ±‡ç¼–è¯­è¨€ç”šè‡³æœºå™¨è¯­è¨€æ¥ç¼–å†™(???) è€Œç¨€ç¼ºä¸”æ˜‚è´µçš„è®¡ç®—æœºç”±ä¸“ä¸šçš„ç®¡ç†å‘˜è´Ÿè´£æ“ä½œï¼Œå°±å’Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç« æ‰€åšçš„äº‹æƒ…ä¸€æ ·ï¼Œä»–ä»¬æ‰‹åŠ¨å°†å¡ç‰‡è¾“å…¥è®¡ç®—æœºï¼Œç­‰">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://roxy5201314.github.io/images/64.png">
<meta property="og:image" content="https://roxy5201314.github.io/images/65.png">
<meta property="og:image" content="https://roxy5201314.github.io/images/66.png">
<meta property="article:published_time" content="2026-02-25T11:00:35.000Z">
<meta property="article:modified_time" content="2026-02-26T09:08:02.501Z">
<meta property="article:author" content="roxy">
<meta property="article:tag" content="trap">
<meta property="article:tag" content="å†…æ ¸æ ˆ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://roxy5201314.github.io/images/64.png">
  
  
  
  <title>batch system - roxy&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"roxy5201314.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/a.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="batch system"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2026-02-25 19:00" pubdate>
          2026å¹´2æœˆ25æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          31k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          256 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">batch system</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="batch-system"><a href="#batch-system" class="headerlink" title="batch system"></a>batch system</h1><h2 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h2><p>è¿™æ˜¯<code>hello kernel</code>çš„åç»­</p>
<p>ä¸Šä¸€ç¯‡æˆ‘ä»¬å®ç°äº†æ‰“å°<code>hello kernel</code>ï¼Œç°åœ¨æˆ‘ä»¬ç»§ç»­è¿­ä»£</p>
<p>å…ˆä»‹ç»ä¸€ä¸‹<em>å†å²</em></p>
<p>åœ¨è®¡ç®—æœºåˆšåˆšè¯ç”Ÿçš„å¹´ä»£ï¼Œå¾ˆå¤šäº‹æƒ…å¹¶ä¸åƒæˆ‘ä»¬æƒ³è±¡çš„é‚£ä¹ˆç®€å•</p>
<p>å½“æ—¶ï¼Œç¨‹åºè¢«è®°å½•åœ¨æ‰“å­”çš„å¡ç‰‡ä¸Šï¼Œä½¿ç”¨æ±‡ç¼–è¯­è¨€ç”šè‡³æœºå™¨è¯­è¨€æ¥ç¼–å†™(???)</p>
<p>è€Œç¨€ç¼ºä¸”æ˜‚è´µçš„è®¡ç®—æœºç”±ä¸“ä¸šçš„ç®¡ç†å‘˜è´Ÿè´£æ“ä½œï¼Œå°±å’Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç« æ‰€åšçš„äº‹æƒ…ä¸€æ ·ï¼Œä»–ä»¬æ‰‹åŠ¨å°†å¡ç‰‡è¾“å…¥è®¡ç®—æœºï¼Œç­‰å¾…ç¨‹åºè¿è¡Œç»“æŸæˆ–è€…ç»ˆæ­¢ç¨‹åºçš„è¿è¡Œã€‚æœ€åï¼Œä»–ä»¬ä»è®¡ç®—æœºçš„è¾“å‡ºç«¯â€”â€”ä¹Ÿå°±æ˜¯<code>æ‰“å°æœº</code>ä¸­å–å‡ºç¨‹åºçš„è¾“å‡ºå¹¶äº¤ç»™æ­£åœ¨ä¼‘æ¯å®¤ç­‰å¾…çš„ç¨‹åºæäº¤è€…â€¦</p>
<p>å®é™…ä¸Šï¼Œè¿™æ ·åšæ˜¯ä¸€ç§å¯¹äºçè´µçš„è®¡ç®—èµ„æºçš„æµªè´¹!</p>
<p>ç³»ç»Ÿç®¡ç†å‘˜åœ¨æˆ¿é—´çš„å„ä¸ªåœ°æ–¹è·‘æ¥è·‘å»ï¼Œæˆ–æ˜¯ç­‰å¾…æ‰“å°æœºçš„è¾“å‡ºçš„è¿™äº›æ—¶é—´æ®µï¼Œè®¡ç®—æœºéƒ½å¹¶æ²¡æœ‰åœ¨å·¥ä½œï¼Œè€Œäººä»¬å¸Œæœ›è®¡ç®—æœºèƒ½å¤Ÿä¸é—´æ–­çš„å·¥ä½œä¸”ä¸“æ³¨äºè®¡ç®—ä»»åŠ¡æœ¬èº«!</p>
<p>äºæ˜¯ï¼Œ<strong>æ‰¹å¤„ç†ç³»ç»Ÿ</strong>(Batch System)åº”è¿è€Œç”Ÿ!å³æœ¬ç¯‡çš„ä¸»é¢˜~</p>
<p>å…¶å«ä¹‰ä¸º:å°†å¤šä¸ªç¨‹åºæ‰“åŒ…åˆ°ä¸€èµ·è¾“å…¥è®¡ç®—æœºï¼Œè€Œå½“ä¸€ä¸ªç¨‹åºè¿è¡Œç»“æŸåï¼Œè®¡ç®—æœºä¼š<strong>è‡ªåŠ¨</strong>åŠ è½½ä¸‹ä¸€ä¸ªç¨‹åºåˆ°å†…å­˜å¹¶å¼€å§‹æ‰§è¡Œ</p>
<p>å½“è½¯ä»¶æœ‰äº†ä»£æ›¿æ“ä½œå‘˜çš„ç®¡ç†å’Œæ“ä½œèƒ½åŠ›åï¼Œä¾¿å¼€å§‹å½¢æˆçœŸæ­£æ„ä¹‰ä¸Šçš„<strong>æ“ä½œç³»ç»Ÿ</strong>äº†!</p>
<p>åŒæ—¶ï¼Œåº”ç”¨ç¨‹åºæ€»æ˜¯éš¾å…ä¼šå‡ºç°é”™è¯¯ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œé”™è¯¯å¯¼è‡´å…¶å®ƒç¨‹åºæˆ–è€…æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿéƒ½æ— æ³•è¿è¡Œå°±å¤ªç³Ÿç³•äº†!</p>
<p>äººä»¬å¸Œæœ›ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„é”™è¯¯ä¸è¦å½±å“åˆ°å…¶å®ƒåº”ç”¨ç¨‹åºï¼Œæ“ä½œç³»ç»Ÿå’Œæ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿï¼Œè¿™å°±éœ€è¦æ“ä½œç³»ç»Ÿèƒ½å¤Ÿç»ˆæ­¢å‡ºé”™çš„åº”ç”¨ç¨‹åºï¼Œè½¬è€Œè¿è¡Œä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åº</p>
<p>è¿™ç§<strong>ä¿æŠ¤</strong>è®¡ç®—æœºç³»ç»Ÿä¸å—æœ‰æ„æˆ–æ— æ„å‡ºé”™çš„ç¨‹åºç ´åçš„æœºåˆ¶è¢«ç§°ä¸º<strong>ç‰¹æƒçº§</strong>(<code>Privilege</code>)æœºåˆ¶ï¼Œå®ƒè®©åº”ç”¨ç¨‹åºè¿è¡Œåœ¨<strong>ç”¨æˆ·æ€</strong>ï¼Œè€Œæ“ä½œç³»ç»Ÿè¿è¡Œåœ¨<strong>å†…æ ¸æ€</strong>ï¼Œä¸”å®ç°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„éš”ç¦»ï¼Œè¿™éœ€è¦è®¡ç®—æœºè½¯ä»¶å’Œç¡¬ä»¶çš„å…±åŒåŠªåŠ›ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æœ¬ç¯‡æ‰€è¦å®ç°çš„å†…å®¹â€¦</p>
<p>åŸºäºç»¼åˆè€ƒé‡ï¼Œæˆ‘ä»¬æ—¢è¦ç¡®ä¿æ“ä½œç³»ç»Ÿçš„<code>å®‰å…¨</code>ï¼ŒåŒæ—¶è¿˜éœ€è¦ç¡®ä¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿå¾—åˆ°æ“ä½œç³»ç»Ÿçš„æœåŠ¡ï¼Œå³åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿè¿˜éœ€è¦æœ‰<strong>äº¤äº’</strong>çš„æ‰‹æ®µï¼Œå³<code>ç³»ç»Ÿè°ƒç”¨</code>ï¼Œä½¿å¾—ä½ç‰¹æƒçº§è½¯ä»¶(ä¸€èˆ¬åº”ç”¨)åªèƒ½åšé«˜ç‰¹æƒçº§è½¯ä»¶(æ“ä½œç³»ç»Ÿ)å…è®¸å®ƒåšçš„ï¼Œä¸”è¶…å‡ºä½ç‰¹æƒçº§è½¯ä»¶èƒ½åŠ›çš„åŠŸèƒ½å¿…é¡»å¯»æ±‚é«˜ç‰¹æƒçº§è½¯ä»¶çš„å¸®åŠ©</p>
<p>å…·ä½“é€šè¿‡è¿™ä¸¤æ¡æ±‡ç¼–æŒ‡ä»¤å®ç°(risc-v)</p>
<ul>
<li><p><code>ecall</code> : å…·æœ‰ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ‰§è¡Œç¯å¢ƒåˆ‡æ¢èƒ½åŠ›çš„å‡½æ•°è°ƒç”¨æŒ‡ä»¤</p>
</li>
<li><p><code>sret</code> : å…·æœ‰å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„æ‰§è¡Œç¯å¢ƒåˆ‡æ¢èƒ½åŠ›çš„å‡½æ•°è¿”å›æŒ‡ä»¤</p>
</li>
</ul>
<p><img src="/images/64.png" srcset="/img/loading.gif" lazyload alt="ç†è§£"></p>
<p>åŒæ—¶ä¸ºäº†ä¿è¯å®‰å…¨ï¼Œæˆ‘ä»¬è‡³å°‘è¦ä¿è¯</p>
<ul>
<li><p>åº”ç”¨ç¨‹åºä¸èƒ½è®¿é—®ä»»æ„çš„åœ°å€ç©ºé—´</p>
</li>
<li><p>åº”ç”¨ç¨‹åºä¸èƒ½æ‰§è¡ŒæŸäº›å¯èƒ½ç ´åè®¡ç®—æœºç³»ç»Ÿçš„æŒ‡ä»¤</p>
</li>
</ul>
<p><img src="/images/65.png" srcset="/img/loading.gif" lazyload alt="ç†è§£"></p>
<p>è¿™æ ·ï¼Œæ¯å±‚ç‰¹æƒçº§çš„è½¯ä»¶éƒ½åªèƒ½åšé«˜ç‰¹æƒçº§è½¯ä»¶å…è®¸å®ƒåšçš„(<code>trap</code>é€šè¿‡system call)ï¼Œä¸”ä¸ä¼šäº§ç”Ÿä»€ä¹ˆæ’¼åŠ¨é«˜ç‰¹æƒçº§è½¯ä»¶çš„äº‹æƒ…ï¼Œä¸€æ—¦ä½ç‰¹æƒçº§è½¯ä»¶çš„è¦æ±‚è¶…å‡ºäº†å…¶èƒ½åŠ›èŒƒå›´ï¼Œå°±å¿…é¡»å¯»æ±‚é«˜ç‰¹æƒçº§è½¯ä»¶çš„å¸®åŠ©ï¼Œå¦åˆ™å°±æ˜¯ä¸€ç§<strong>å¼‚å¸¸</strong>(exception)è¡Œä¸ºäº†</p>
<p>å…¶å®ƒçš„å¼‚å¸¸åˆ™ä¸€èˆ¬æ˜¯åœ¨æ‰§è¡ŒæŸä¸€æ¡æŒ‡ä»¤çš„æ—¶å€™å‘ç”Ÿäº†æŸç§é”™è¯¯(å¦‚é™¤é›¶ æ— æ•ˆåœ°å€è®¿é—® æ— æ•ˆæŒ‡ä»¤ç­‰)ï¼Œæˆ–å¤„ç†å™¨è®¤ä¸ºå¤„äºå½“å‰ç‰¹æƒçº§ä¸‹æ‰§è¡Œçš„å½“å‰æŒ‡ä»¤æ˜¯é«˜ç‰¹æƒçº§æŒ‡ä»¤ æˆ– ä¼šè®¿é—®ä¸åº”è¯¥è®¿é—®çš„é«˜ç‰¹æƒçº§çš„èµ„æº(å¯èƒ½å±å®³ç³»ç»Ÿ)</p>
<p>ç¢°åˆ°è¿™äº›æƒ…å†µï¼Œå°±éœ€è¦å°†æ§åˆ¶è½¬äº¤ç»™é«˜ç‰¹æƒçº§çš„è½¯ä»¶(å¦‚<code>æ“ä½œç³»ç»Ÿ</code>)æ¥å¤„ç†</p>
<p>å½“é”™è¯¯&#x2F;å¼‚å¸¸æ¢å¤åï¼Œåˆ™å¯é‡æ–°å›åˆ°ä½ä¼˜å…ˆçº§è½¯ä»¶å»æ‰§è¡Œ</p>
<p>å¦‚æœä¸èƒ½æ¢å¤é”™è¯¯&#x2F;å¼‚å¸¸ï¼Œé‚£é«˜ç‰¹æƒçº§è½¯ä»¶å¯ä»¥<strong>æ€æ­»</strong>å’Œæ¸…é™¤ä½ç‰¹æƒçº§è½¯ä»¶ï¼Œé¿å…ç ´åæ•´ä¸ªæ‰§è¡Œç¯å¢ƒ!</p>
<div class="note note-success">
            <p><strong>tips</strong> :<br>é€šç”¨å¯„å­˜å™¨ : x0 ~ x31</p> <ul> <li><p><code>x10~x17</code> : å¯¹åº” <code>a0~a7</code></p> </li> <li><p>x1 ï¼šå¯¹åº” <strong>ra</strong></p> </li> <li><p>x2 : å¯¹åº” <strong>sp</strong><br>æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨(<code>CSR</code> Control and Status Register)</p> </li> <li><p><strong>sstatus</strong> : SPPç­‰å­—æ®µç»™å‡ºTrapå‘ç”Ÿä¹‹å‰CPUå¤„åœ¨å“ªä¸ªç‰¹æƒçº§(S&#x2F;U)ç­‰ä¿¡æ¯</p> </li> <li><p><code>sepc</code> : å½“Trapæ˜¯ä¸€ä¸ªå¼‚å¸¸çš„æ—¶å€™ï¼Œè®°å½•Trapå‘ç”Ÿä¹‹å‰æ‰§è¡Œçš„æœ€åä¸€æ¡æŒ‡ä»¤çš„åœ°å€</p> </li> <li><p><code>scause</code> : æè¿°Trapçš„åŸå› </p> </li> <li><p><code>stval</code> : ç»™å‡ºTrapé™„åŠ ä¿¡æ¯</p> </li> <li><p><code>stvec</code> : æ§åˆ¶Trapå¤„ç†ä»£ç çš„å…¥å£åœ°å€</p> </li> </ul> 
          </div>

<hr>
<h2 id="å®ç°åº”ç”¨ç¨‹åº"><a href="#å®ç°åº”ç”¨ç¨‹åº" class="headerlink" title="å®ç°åº”ç”¨ç¨‹åº"></a>å®ç°åº”ç”¨ç¨‹åº</h2><p>å¼€å§‹å§!</p>
<p>æˆ‘ä»¬è‡ªé¡¶å‘ä¸‹(ç®€å• -&gt; éš¾ ? )</p>
<p>ps: å…¶å®ä¹Ÿä¸éš¾ ğŸ˜</p>
<p>æˆ‘ä»¬å…ˆæ¥å®ç°<em>åº”ç”¨ç¨‹åº</em>~</p>
<p>é¡¹ç›®ä¸­æœ‰:</p>
<ul>
<li><p>hello_world ï¼šåœ¨å±å¹•ä¸Šæ‰“å°ä¸€è¡Œ Hello world from user mode program!</p>
</li>
<li><p>store_fault ï¼šè®¿é—®ä¸€ä¸ªéæ³•çš„ç‰©ç†åœ°å€ï¼Œæµ‹è¯•æ‰¹å¤„ç†ç³»ç»Ÿæ˜¯å¦ä¼šè¢«è¯¥é”™è¯¯å½±å“</p>
</li>
<li><p>power ï¼šä¸æ–­åœ¨è®¡ç®—æ“ä½œå’Œæ‰“å°å­—ç¬¦ä¸²æ“ä½œä¹‹é—´è¿›è¡Œç‰¹æƒçº§åˆ‡æ¢ï¼Œæµ‹è¯•trapæ˜¯å¦æ­£å¸¸</p>
</li>
<li><p>priv_inst : ç”¨æˆ·æ€æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ï¼Œæµ‹è¯•</p>
</li>
<li><p>priv_csr : ç”¨æˆ·æ€æ‰§è¡Œè®¿é—®ç‰¹æƒçº§CSRçš„æŒ‡ä»¤ï¼Œä¾æ—§æµ‹è¯•</p>
</li>
</ul>
<p>å…·ä½“è§ä¸‹:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">//hello_world</span><br><span class="hljs-meta">#![no_std]</span><br><span class="hljs-meta">#![no_main]</span><br><br><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> user_lib;<br><br><span class="hljs-meta">#[unsafe(no_mangle)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;good morning good noon and good night my neighbor! have fun!&quot;</span>);<br>    <span class="hljs-number">0</span><br>&#125;<br><span class="hljs-comment">//store_fault</span><br><span class="hljs-meta">#![no_std]</span><br><span class="hljs-meta">#![no_main]</span><br><br><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> user_lib;<br><br><span class="hljs-meta">#[unsafe(no_mangle)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;bitch1 : I will insert an invalid store operation to destroy you!&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;kernel : no problem! and I will kill you!&quot;</span>);<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        core::ptr::null_mut::&lt;<span class="hljs-type">u8</span>&gt;().<span class="hljs-title function_ invoke__">write_volatile</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-number">0</span><br>&#125;<br><span class="hljs-comment">//power</span><br><span class="hljs-meta">#![no_std]</span><br><span class="hljs-meta">#![no_main]</span><br><br><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> user_lib;<br><br><span class="hljs-keyword">const</span> SIZE: <span class="hljs-type">usize</span> = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">const</span> P: <span class="hljs-type">u32</span> = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> STEP: <span class="hljs-type">usize</span> = <span class="hljs-number">100000</span>;<br><span class="hljs-keyword">const</span> MOD: <span class="hljs-type">u32</span> = <span class="hljs-number">10007</span>;<br><br><span class="hljs-meta">#[unsafe(no_mangle)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pow</span> = [<span class="hljs-number">0u32</span>; SIZE];<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">index</span>: <span class="hljs-type">usize</span> = <span class="hljs-number">0</span>;<br>    pow[index] = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>..=STEP &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">last</span> = pow[index];<br>        index = (index + <span class="hljs-number">1</span>) % SIZE;<br>        pow[index] = last * P % MOD;<br>        <span class="hljs-keyword">if</span> i % <span class="hljs-number">10000</span> == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;^&#123;&#125;=&#123;&#125;(MOD &#123;&#125;)&quot;</span>, P, i, pow[index], MOD);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;I am so powerful! so easy job!&quot;</span>);<br>    <span class="hljs-number">0</span><br>&#125;<br><span class="hljs-comment">//priv_inst</span><br><span class="hljs-meta">#![no_std]</span><br><span class="hljs-meta">#![no_main]</span><br><br><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> user_lib;<br><br><span class="hljs-keyword">use</span> core::arch::asm;<br><br><span class="hljs-meta">#[unsafe(no_mangle)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;bitch2 : I will execute privileged instruction in U Mode! hahaha!!!&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;kernel : fuck you bitch! I will kill you!&quot;</span>);<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        asm!(<span class="hljs-string">&quot;sret&quot;</span>);<br>    &#125;<br>    <span class="hljs-number">0</span><br>&#125;<br><span class="hljs-comment">//priv_csr</span><br><span class="hljs-meta">#![no_std]</span><br><span class="hljs-meta">#![no_main]</span><br><br><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> user_lib;<br><br><span class="hljs-keyword">use</span> riscv::register::sstatus::&#123;<span class="hljs-keyword">self</span>, SPP&#125;;<br><br><span class="hljs-meta">#[unsafe(no_mangle)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;bitch3 : I will access privileged CSR in U Mode!&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;kernel : shit! so many bitches! are you kidding? go and die!&quot;</span>);<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        sstatus::<span class="hljs-title function_ invoke__">set_spp</span>(SPP::User);<br>    &#125;<br>    <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜èƒ½å¤Ÿçœ‹åˆ°ä»£ç ä¸­å°è¯•å¼•å…¥äº†å¤–éƒ¨åº“:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> user_lib;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªå¤–éƒ¨åº“å…¶å®å°±æ˜¯userç›®å½•ä¸‹çš„lib.rsä»¥åŠå®ƒå¼•ç”¨çš„è‹¥å¹²å­æ¨¡å—</p>
<p>è‡³äºè¿™ä¸ªå¤–éƒ¨åº“ä¸ºä½•å«user_libè€Œä¸å«lib.rsæ‰€åœ¨ç›®å½•çš„åå­—user???</p>
<p>æ˜¯å› ä¸ºåœ¨<code>user/Cargo.toml</code>ä¸­æˆ‘ä»¬å¯¹äºåº“çš„åå­—è¿›è¡Œäº†è®¾ç½®<code>name = &quot;user_lib&quot;</code></p>
<p>ã€‚ã€‚ã€‚</p>
<p>å®ƒä½œä¸ºbinç›®å½•ä¸‹çš„æºç¨‹åºæ‰€ä¾èµ–çš„ç”¨æˆ·åº“ï¼Œç­‰ä»·äºå…¶å®ƒç¼–ç¨‹è¯­è¨€æä¾›çš„<em>æ ‡å‡†åº“</em></p>
<p>åœ¨<code>lib.rs</code>ä¸­æˆ‘ä»¬å®šä¹‰äº†ç”¨æˆ·åº“çš„å…¥å£ç‚¹<code>_start</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[no_mangle]</span><br><span class="hljs-meta">#[link_section = <span class="hljs-string">&quot;.text.entry&quot;</span>]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">_start</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-title function_ invoke__">clear_bss</span>();<br>    <span class="hljs-title function_ invoke__">exit</span>(<span class="hljs-title function_ invoke__">main</span>());<br>    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;unreachable after sys_exit!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>éƒ½æ˜¯ä¸Šä¸€ç¯‡çš„åŸºç¡€æ“ä½œ~</p>
<p>æœ€å…³é”®çš„ä¾¿æ˜¯<code>exit(main())</code>äº§ç”Ÿçš„<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œåé¢è§äº†â€¦</p>
<p>æˆ‘ä»¬è¿˜åœ¨lib.rsä¸­çœ‹åˆ°äº†å¦ä¸€ä¸ªmain:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[linkage = <span class="hljs-string">&quot;weak&quot;</span>]</span><br><span class="hljs-meta">#[no_mangle]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Cannot find main!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½¿ç”¨rustçš„å®å°†å…¶å‡½æ•°ç¬¦å·mainæ ‡å¿—ä¸º<strong>å¼±é“¾æ¥</strong>ï¼Œè¿™æ ·åœ¨æœ€åé“¾æ¥çš„æ—¶å€™ï¼Œè™½ç„¶åœ¨lib.rså’Œbinç›®å½•ä¸‹çš„æŸä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰mainç¬¦å·ï¼Œä½†ç”±äº<code>lib.rs</code>ä¸­çš„<em>main</em>ç¬¦å·æ˜¯å¼±é“¾æ¥ï¼Œé“¾æ¥å™¨ä¼šä½¿ç”¨binç›®å½•ä¸‹çš„åº”ç”¨ä¸»é€»è¾‘ä½œä¸ºmain~</p>
<p>ä¸ºäº†æ”¯æŒä¸Šè¿°è¿™ç§é“¾æ¥æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦åœ¨lib.rsçš„å¼€å¤´åŠ å…¥:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#![feature(linkage)]</span><br></code></pre></td></tr></table></figure>

<p>åŒç†ï¼Œæˆ‘ä»¬è¦è‡ªå·±å¸ƒç½®<code>å†…å­˜å¸ƒå±€</code></p>
<p>å¦‚ä¸‹</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs stata">OUTPUT_ARCH(riscv)<br>ENTRY(_start)<br><br>BASE_ADDRESS = 0x80400000;<br><br>SECTIONS<br>&#123;<br>    . = BASE_ADDRESS;<br>    .text : &#123;<br><span class="hljs-comment">        *(.text.entry)</span><br><span class="hljs-comment">        *(.text .text.*)</span><br>    &#125;<br>    .rodata : &#123;<br><span class="hljs-comment">        *(.rodata .rodata.*)</span><br><span class="hljs-comment">        *(.srodata .srodata.*)</span><br>    &#125;<br>    .data : &#123;<br><span class="hljs-comment">        *(.data .data.*)</span><br><span class="hljs-comment">        *(.sdata .sdata.*)</span><br>    &#125;<br>    .bss : &#123;<br>        start_bss = .;<br><span class="hljs-comment">        *(.bss .bss.*)</span><br><span class="hljs-comment">        *(.sbss .sbss.*)</span><br>        end_bss = .;<br>    &#125;<br>    /<span class="hljs-keyword">DISCARD</span>/ : &#123;<br><span class="hljs-comment">        *(.eh_frame)</span><br><span class="hljs-comment">        *(.debug*)</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é¦–å…ˆå°†ç¨‹åºçš„èµ·å§‹ç‰©ç†åœ°å€è°ƒæ•´ä¸º<code>0x80400000</code>ï¼Œä¸‰ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šè¢«åŠ è½½åˆ°è¿™ä¸ªç‰©ç†åœ°å€ä¸Šè¿è¡Œ</p>
<p>ç„¶åå°†<code>_start</code>æ‰€åœ¨çš„<code>.text.entry</code>æ”¾åœ¨æ•´ä¸ªç¨‹åºçš„å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰¹å¤„ç†ç³»ç»Ÿåªè¦åœ¨åŠ è½½ä¹‹åè·³è½¬åˆ°<code>0x80400000</code>å°±å·²ç»è¿›å…¥äº†ç”¨æˆ·åº“çš„å…¥å£ç‚¹ï¼Œå¹¶ä¼šåœ¨åˆå§‹åŒ–ä¹‹åè·³è½¬åˆ°åº”ç”¨ç¨‹åºä¸»é€»è¾‘</p>
<p>ç„¶åä¾æ—§æä¾›äº†æœ€ç»ˆç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„<code>.bss</code>æ®µçš„èµ·å§‹å’Œç»ˆæ­¢åœ°å€ï¼Œæ–¹ä¾¿<code>clear_bss</code>å‡½æ•°ä½¿ç”¨</p>
<div class="note note-primary">
            <p>æˆ‘ä»¬ä¾ç„¶å¾—æ‰‹åŠ¨æ¸…ç©ºéœ€è¦é›¶åˆå§‹åŒ–çš„.bssæ®µ</p> <p>å¾ˆé—æ†¾åˆ°ç›®å‰ä¸ºæ­¢åº•å±‚çš„æ‰¹å¤„ç†ç³»ç»Ÿè¿˜æ²¡æœ‰è¿™ä¸ªèƒ½åŠ›ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½åœ¨ç”¨æˆ·åº“ä¸­å®ŒæˆğŸ˜­</p> <p>ps: æˆ‘åˆç”¨ä¸Šemojiäº†ğŸ˜</p> 
          </div>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°<strong>ç³»ç»Ÿè°ƒç”¨</strong>!</p>
<p>æˆ‘ä»¬å…ˆçº¦å®šå¦‚ä¸‹ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// åŠŸèƒ½ï¼šå°†å†…å­˜ä¸­ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ã€‚</span><br><span class="hljs-comment">/// å‚æ•°ï¼š`fd` è¡¨ç¤ºå¾…å†™å…¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼›</span><br><span class="hljs-comment">///      `buf` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼›</span><br><span class="hljs-comment">///      `len` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„é•¿åº¦ã€‚</span><br><span class="hljs-comment">/// è¿”å›å€¼ï¼šè¿”å›æˆåŠŸå†™å…¥çš„é•¿åº¦ã€‚</span><br><span class="hljs-comment">/// syscall IDï¼š64</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_write</span>(fd: <span class="hljs-type">usize</span>, buf: *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>, len: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span>;<br><br><span class="hljs-comment">/// åŠŸèƒ½ï¼šé€€å‡ºåº”ç”¨ç¨‹åºå¹¶å°†è¿”å›å€¼å‘ŠçŸ¥æ‰¹å¤„ç†ç³»ç»Ÿã€‚</span><br><span class="hljs-comment">/// å‚æ•°ï¼š`exit_code` è¡¨ç¤ºåº”ç”¨ç¨‹åºçš„è¿”å›å€¼ã€‚</span><br><span class="hljs-comment">/// è¿”å›å€¼ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨ä¸åº”è¯¥è¿”å›ã€‚</span><br><span class="hljs-comment">/// syscall IDï¼š93</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_exit</span>(exit_code: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> !;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çŸ¥é“ç³»ç»Ÿè°ƒç”¨å®é™…ä¸Šæ˜¯æ±‡ç¼–æŒ‡ä»¤çº§çš„äºŒè¿›åˆ¶æ¥å£</p>
<p>å› æ­¤è¿™é‡Œç»™å‡ºçš„åªæ˜¯ä½¿ç”¨rustè¯­è¨€æè¿°çš„<code>API</code>ç‰ˆæœ¬</p>
<p>åœ¨å®é™…è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ç…§<code>RISC-V</code>è°ƒç”¨è§„èŒƒ(å³ABIæ ¼å¼)åœ¨åˆé€‚çš„å¯„å­˜å™¨ä¸­æ”¾ç½®ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œç„¶åæ‰§è¡Œ$ecall$æŒ‡ä»¤è§¦å‘Trap</p>
<p>åœ¨Trapå›åˆ°Uæ¨¡å¼çš„åº”ç”¨ç¨‹åºä»£ç ä¹‹åï¼Œä¼šä»<em>ecall</em>çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶æˆ‘ä»¬èƒ½å¤ŸæŒ‰ç…§è°ƒç”¨è§„èŒƒåœ¨åˆé€‚çš„å¯„å­˜å™¨ä¸­è¯»å–è¿”å›å€¼</p>
<p>ps: ğŸ˜ƒğŸ˜€ğŸ˜„ ORW</p>
<div class="note note-secondary">
            <p>çº¦å®šå¯„å­˜å™¨<code>a0~a6</code>ä¾æ¬¡ä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œ<code>a0</code>ä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œå¯„å­˜å™¨<code>a7</code>ç”¨æ¥ä¼ é€’<strong>syscall ID</strong></p> 
          </div>

<p>ç”±äºè¿™è¶…å‡ºäº†rustè¯­è¨€çš„è¡¨è¾¾èƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­ä½¿ç”¨å†…åµŒæ±‡ç¼–æ¥å®Œæˆå‚æ•°&#x2F;è¿”å›å€¼ç»‘å®šå’Œ<code>ecall</code>æŒ‡ä»¤çš„æ’å…¥</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// user/src/syscall.rs</span><br><span class="hljs-keyword">use</span> core::arch::asm;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">syscall</span>(id: <span class="hljs-type">usize</span>, args: [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ret</span>: <span class="hljs-type">isize</span>;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        asm!(<br>            <span class="hljs-string">&quot;ecall&quot;</span>,<br>            <span class="hljs-title function_ invoke__">inlateout</span>(<span class="hljs-string">&quot;x10&quot;</span>) args[<span class="hljs-number">0</span>] =&gt; ret,<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x11&quot;</span>) args[<span class="hljs-number">1</span>],<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x12&quot;</span>) args[<span class="hljs-number">2</span>],<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x17&quot;</span>) id<br>        );<br>    &#125;<br>    ret<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„:ç”±äº<code>a0</code>æ—¢æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œåˆä¿å­˜è¿”å›å€¼ï¼ŒåŒæ—¶ä½œä¸ºè¾“å…¥å’Œè¾“å‡ºï¼Œå› æ­¤ç”¨<code>inlateout</code></p>
<p>äºæ˜¯<code>sys_write</code>å’Œ<code>sys_exit</code>åªéœ€å°†<em>syscall</em>è¿›è¡ŒåŒ…è£…</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// user/src/syscall.rs</span><br><br><span class="hljs-keyword">const</span> SYSCALL_WRITE: <span class="hljs-type">usize</span> = <span class="hljs-number">64</span>;<br><span class="hljs-keyword">const</span> SYSCALL_EXIT: <span class="hljs-type">usize</span> = <span class="hljs-number">93</span>;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_write</span>(fd: <span class="hljs-type">usize</span>, buffer: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-title function_ invoke__">syscall</span>(SYSCALL_WRITE, [fd, buffer.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, buffer.<span class="hljs-title function_ invoke__">len</span>()])<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_exit</span>(xstate: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-title function_ invoke__">syscall</span>(SYSCALL_EXIT, [xstate <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>])<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„<em>sys_write</em>ä½¿ç”¨ä¸€ä¸ª<code>&amp;[u8]</code>åˆ‡ç‰‡ç±»å‹æ¥æè¿°ç¼“å†²åŒºï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>èƒ–æŒ‡é’ˆ</strong>(Fat Pointer)ï¼Œé‡Œé¢æ—¢åŒ…å«ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼Œè¿˜åŒ…å«ç¼“å†²åŒºçš„é•¿åº¦</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ†åˆ«é€šè¿‡ as_ptr å’Œ len æ–¹æ³•å–å‡ºå®ƒä»¬å¹¶ç‹¬ç«‹åœ°ä½œä¸ºå®é™…çš„ç³»ç»Ÿè°ƒç”¨å‚æ•°!</p>
<p>æˆ‘ä»¬å°†ä¸Šè¿°ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åœ¨ç”¨æˆ·åº“<code>user_lib</code>ä¸­è¿›ä¸€æ­¥<em>å°è£…</em>ï¼Œä»è€Œæ›´åŠ æ¥è¿‘åœ¨Linuxç­‰å¹³å°çš„å®é™…ç³»ç»Ÿè°ƒç”¨æ¥å£~</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// user/src/lib.rs</span><br><span class="hljs-keyword">use</span> syscall::*;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write</span>(fd: <span class="hljs-type">usize</span>, buf: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123; <span class="hljs-title function_ invoke__">sys_write</span>(fd, buf) &#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">exit</span>(exit_code: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123; <span class="hljs-title function_ invoke__">sys_exit</span>(exit_code) &#125;<br></code></pre></td></tr></table></figure>

<p>åŒæ—¶ï¼Œæˆ‘ä»¬æŠŠconsoleå­æ¨¡å—ä¸­<code>Stdout::write_str</code>æ”¹æˆåŸºäº<em>write</em>çš„å®ç°ï¼Œä¸”ä¼ å…¥çš„<strong>fd</strong>å‚æ•°è®¾ç½®ä¸º$1$ï¼Œå®ƒä»£è¡¨æ ‡å‡†è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¾“å‡ºåˆ°å±å¹•</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// user/src/console.rs</span><br><span class="hljs-keyword">const</span> STDOUT: <span class="hljs-type">usize</span> = <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Write</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Stdout</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_str</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> fmt::<span class="hljs-type">Result</span> &#123;<br>        <span class="hljs-title function_ invoke__">write</span>(STDOUT, s.<span class="hljs-title function_ invoke__">as_bytes</span>());<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>exitæ¥å£åˆ™åœ¨ç”¨æˆ·åº“ä¸­çš„<code>_start</code>å†…ä½¿ç”¨ï¼Œå½“åº”ç”¨ç¨‹åºä¸»é€»è¾‘mainè¿”å›ä¹‹åï¼Œä½¿ç”¨å®ƒé€€å‡ºåº”ç”¨ç¨‹åºå¹¶å°†è¿”å›å€¼å‘ŠçŸ¥åº•å±‚çš„<strong>æ‰¹å¤„ç†</strong>ç³»ç»Ÿï¼Œä»è€Œç»§ç»­åŠ è½½ä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åº~</p>
<p>å¤ªæœ‰æ„æ€äº†å§!â˜ºï¸</p>
<hr>
<h2 id="å®ç°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿ"><a href="#å®ç°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿ" class="headerlink" title="å®ç°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿ"></a>å®ç°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿ</h2><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç€æ‰‹å®ç°<em>æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿ</em>äº†</p>
<p>batch systemï¼Œå¯åŠ¨!</p>
<p>åœ¨æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯å½“ä¸€ä¸ªåº”ç”¨æ‰§è¡Œå®Œæ¯•ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å°†ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„åº”ç”¨çš„ä»£ç å’Œæ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œé€šè¿‡å¦‚ä¸‹æ–¹å¼:</p>
<ul>
<li><p><code>é™æ€ç»‘å®š</code> : é€šè¿‡ä¸€å®šçš„ç¼–ç¨‹æŠ€å·§ï¼ŒæŠŠå¤šä¸ªåº”ç”¨ç¨‹åºä»£ç å’Œæ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä»£ç <em>ç»‘å®š</em>åœ¨ä¸€èµ·</p>
</li>
<li><p><code>åŠ¨æ€åŠ è½½</code> : åŸºäºé™æ€ç¼–ç ç•™ä¸‹çš„<em>ç»‘å®š</em>ä¿¡æ¯ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æ‰¾åˆ°æ¯ä¸ªåº”ç”¨ç¨‹åºæ–‡ä»¶äºŒè¿›åˆ¶ä»£ç çš„èµ·å§‹åœ°å€å’Œé•¿åº¦ï¼Œå¹¶èƒ½åŠ è½½åˆ°å†…å­˜ä¸­è¿è¡Œ</p>
</li>
</ul>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†åº”ç”¨ç¨‹åºé“¾æ¥åˆ°å†…æ ¸</p>
<p>åœ¨<code>os/src/main.rs</code>ä¸­æœ‰:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">global_asm!(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;link_app.S&quot;</span>));<br></code></pre></td></tr></table></figure>

<p>å†…å®¹ä¸º:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs rust"># os/src/link_app.S<br><br>    .align <span class="hljs-number">3</span><br>    .section .data<br>    .global _num_app<br>_num_app:<br>    .quad <span class="hljs-number">5</span><br>    .quad app_0_start<br>    .quad app_1_start<br>    .quad app_2_start<br>    .quad app_3_start<br>    .quad app_4_start<br>    .quad app_4_end<br><br>    .section .data<br>    .global app_0_start<br>    .global app_0_end<br>app_0_start:<br>    .incbin <span class="hljs-string">&quot;../user/target/riscv64gc-unknown-none-elf/release/00hello_world.bin&quot;</span><br>app_0_end:<br><br>    .section .data<br>    .global app_1_start<br>    .global app_1_end<br>app_1_start:<br>    .incbin <span class="hljs-string">&quot;../user/target/riscv64gc-unknown-none-elf/release/01store_fault.bin&quot;</span><br>app_1_end:<br><br>    .section .data<br>    .global app_2_start<br>    .global app_2_end<br>app_2_start:<br>    .incbin <span class="hljs-string">&quot;../user/target/riscv64gc-unknown-none-elf/release/02power.bin&quot;</span><br>app_2_end:<br><br>    .section .data<br>    .global app_3_start<br>    .global app_3_end<br>app_3_start:<br>    .incbin <span class="hljs-string">&quot;../user/target/riscv64gc-unknown-none-elf/release/03priv_inst.bin&quot;</span><br>app_3_end:<br><br>    .section .data<br>    .global app_4_start<br>    .global app_4_end<br>app_4_start:<br>    .incbin <span class="hljs-string">&quot;../user/target/riscv64gc-unknown-none-elf/release/04priv_csr.bin&quot;</span><br>app_4_end:<br></code></pre></td></tr></table></figure>

<p>åœ¨æ„å»ºæ“ä½œç³»ç»Ÿ(make run)æ—¶ç”±ç”±è„šæœ¬<code>os/build.rs</code>è‡ªåŠ¨ç”Ÿæˆï¼Œå¾ˆå¥½ç†è§£</p>
<div class="note note-info">
            <p><em>build.rs</em>å¦‚ä¸‹ï¼Œå¯è‡ªè¡Œæ¢ç´¢ğŸ˜Œ</p> <figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::fs::&#123;File, read_dir&#125;;<br><span class="hljs-keyword">use</span> std::io::&#123;<span class="hljs-type">Result</span>, Write&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;cargo:rerun-if-changed=../user/src/&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;cargo:rerun-if-changed=&#123;&#125;&quot;</span>, TARGET_PATH);<br>    <span class="hljs-title function_ invoke__">insert_app_data</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>&#125;<br><br><span class="hljs-keyword">static</span> TARGET_PATH: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">&quot;../user/target/riscv64gc-unknown-none-elf/release/&quot;</span>;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">insert_app_data</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">f</span> = File::<span class="hljs-title function_ invoke__">create</span>(<span class="hljs-string">&quot;src/link_app.S&quot;</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">apps</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = <span class="hljs-title function_ invoke__">read_dir</span>(<span class="hljs-string">&quot;../user/src/bin&quot;</span>)<br>        .<span class="hljs-title function_ invoke__">unwrap</span>()<br>        .<span class="hljs-title function_ invoke__">into_iter</span>()<br>        .<span class="hljs-title function_ invoke__">map</span>(|dir_entry| &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">name_with_ext</span> = dir_entry.<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">file_name</span>().<span class="hljs-title function_ invoke__">into_string</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>            name_with_ext.<span class="hljs-title function_ invoke__">drain</span>(name_with_ext.<span class="hljs-title function_ invoke__">find</span>(<span class="hljs-string">&#x27;.&#x27;</span>).<span class="hljs-title function_ invoke__">unwrap</span>()..name_with_ext.<span class="hljs-title function_ invoke__">len</span>());<br>            name_with_ext<br>        &#125;)<br>        .<span class="hljs-title function_ invoke__">collect</span>();<br>    apps.<span class="hljs-title function_ invoke__">sort</span>();<br><br>    <span class="hljs-built_in">writeln!</span>(<br>        f,<br>        <span class="hljs-string">r#&quot;</span><br><span class="hljs-string">    .align 3</span><br><span class="hljs-string">    .section .data</span><br><span class="hljs-string">    .global _num_app</span><br><span class="hljs-string">_num_app:</span><br><span class="hljs-string">    .quad &#123;&#125;&quot;#</span>,<br>        apps.<span class="hljs-title function_ invoke__">len</span>()<br>    )?;<br><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..apps.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>        <span class="hljs-built_in">writeln!</span>(f, <span class="hljs-string">r#&quot;    .quad app_&#123;&#125;_start&quot;#</span>, i)?;<br>    &#125;<br>    <span class="hljs-built_in">writeln!</span>(f, <span class="hljs-string">r#&quot;    .quad app_&#123;&#125;_end&quot;#</span>, apps.<span class="hljs-title function_ invoke__">len</span>() - <span class="hljs-number">1</span>)?;<br><br>    <span class="hljs-keyword">for</span> (idx, app) <span class="hljs-keyword">in</span> apps.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;app_&#123;&#125;: &#123;&#125;&quot;</span>, idx, app);<br>        <span class="hljs-built_in">writeln!</span>(<br>            f,<br>            <span class="hljs-string">r#&quot;</span><br><span class="hljs-string">    .section .data</span><br><span class="hljs-string">    .global app_&#123;0&#125;_start</span><br><span class="hljs-string">    .global app_&#123;0&#125;_end</span><br><span class="hljs-string">app_&#123;0&#125;_start:</span><br><span class="hljs-string">    .incbin &quot;&#123;2&#125;&#123;1&#125;.bin&quot;</span><br><span class="hljs-string">app_&#123;0&#125;_end:&quot;#</span>,<br>            idx, app, TARGET_PATH<br>        )?;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure> 
          </div>

<p>ä¸ºäº†æ‰¾åˆ°å¹¶åŠ è½½åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶ç ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªåº”ç”¨ç®¡ç†å™¨ï¼Œä¿å­˜åº”ç”¨æ•°é‡å’Œå„è‡ªçš„ä½ç½®ä¿¡æ¯ï¼Œä»¥åŠå½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ ä¸ªåº”ç”¨äº†</p>
<p>å¹¶æ ¹æ®åº”ç”¨ç¨‹åºä½ç½®ä¿¡æ¯ï¼Œåˆå§‹åŒ–å¥½åº”ç”¨æ‰€éœ€å†…å­˜ç©ºé—´ï¼Œå¹¶åŠ è½½åº”ç”¨æ‰§è¡Œ</p>
<p>åº”ç”¨ç®¡ç†å™¨<code>AppManager</code>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/batch.rs</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppManager</span> &#123;<br>    num_app: <span class="hljs-type">usize</span>,<br>    current_app: <span class="hljs-type">usize</span>,<br>    app_start: [<span class="hljs-type">usize</span>; MAX_APP_NUM + <span class="hljs-number">1</span>],<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å®šä¹‰å¾ˆå¥½ç†è§£ï¼Œä½†æ¥ä¸‹æ¥æˆ‘ä»¬è¦è§£å†³ä¸€ä¸ªå¾ˆç¥ç§˜çš„é—®é¢˜â€¦</p>
<p>æˆ‘ä»¬å¸Œæœ›å°†<em>AppManager</em>å®ä¾‹åŒ–ä¸ºä¸€ä¸ª<strong>å…¨å±€å˜é‡</strong>ï¼Œä½¿å¾—ä»»ä½•å‡½æ•°éƒ½å¯ä»¥ç›´æ¥è®¿é—®</p>
<p>ä½†æ˜¯!</p>
<p>é‡Œé¢çš„<code>current_app</code>å­—æ®µè¡¨ç¤ºå½“å‰æ‰§è¡Œçš„æ˜¯ç¬¬å‡ ä¸ªåº”ç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯ä¿®æ”¹çš„å˜é‡ï¼Œä¼šåœ¨ç³»ç»Ÿè¿è¡ŒæœŸé—´å‘ç”Ÿå˜åŒ–!</p>
<p>ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ç”¨<code>static mut</code></p>
<p>æ˜¾ç„¶è¿™æ˜¯<strong>unsafe</strong>çš„</p>
<p>è€Œæˆ‘ä»¬è¦åœ¨ç¼–ç¨‹ä¸­å°½é‡é¿å…ä½¿ç”¨<code>unsafe</code>ï¼Œè¿™æ ·æ‰èƒ½è®©ç¼–è¯‘å™¨è´Ÿè´£æ›´å¤šçš„å®‰å…¨æ€§æ£€æŸ¥</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨å°½é‡é¿å…è§¦åŠunsafeçš„æƒ…å†µä¸‹ä»èƒ½å£°æ˜å¹¶ä½¿ç”¨å¯å˜çš„å…¨å±€å˜é‡</p>
<div class="note note-info">
            <p><strong>Rust Tips : Rust æ‰€æœ‰æƒæ¨¡å‹å’Œå€Ÿç”¨æ£€æŸ¥</strong></p> <p>è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ Rust çš„<strong>æ‰€æœ‰æƒæ¨¡å‹</strong>ã€‚å®ƒå¯ä»¥ç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬:<code>å€¼</code>(Value)åœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ç»‘å®šåˆ°ä¸€ä¸ª<code>å˜é‡</code>(Variable)ä¸Šã€‚è¿™é‡Œï¼Œ<em>å€¼</em>æŒ‡çš„æ˜¯å‚¨å­˜åœ¨å†…å­˜ä¸­å›ºå®šä½ç½®ï¼Œä¸”æ ¼å¼å±äºæŸç§ç‰¹å®šç±»å‹çš„æ•°æ®ï¼›è€Œå˜é‡å°±æ˜¯æˆ‘ä»¬åœ¨ Rust ä»£ç ä¸­é€šè¿‡ let å£°æ˜çš„å±€éƒ¨å˜é‡æˆ–è€…å‡½æ•°çš„å‚æ•°ç­‰ï¼Œå˜é‡çš„ç±»å‹ä¸å€¼çš„ç±»å‹ç›¸åŒ¹é…ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç§°å€¼çš„<strong>æ‰€æœ‰æƒ</strong>(Ownership)å±äºå®ƒè¢«ç»‘å®šåˆ°çš„å˜é‡ï¼Œä¸”å˜é‡å¯ä»¥ä½œä¸ºè®¿é—®&#x2F;æ§åˆ¶ç»‘å®šåˆ°å®ƒä¸Šé¢çš„å€¼çš„ä¸€ä¸ªåª’ä»‹ã€‚å˜é‡å¯ä»¥å°†å®ƒæ‹¥æœ‰çš„å€¼çš„æ‰€æœ‰æƒè½¬ç§»ç»™å…¶ä»–å˜é‡ï¼Œæˆ–è€…å½“å˜é‡é€€å‡ºå…¶ä½œç”¨åŸŸä¹‹åï¼Œå®ƒæ‹¥æœ‰çš„å€¼ä¹Ÿä¼šè¢«é”€æ¯ï¼Œè¿™æ„å‘³ç€å€¼å ç”¨çš„å†…å­˜æˆ–å…¶ä»–èµ„æºä¼šè¢«å›æ”¶</p> <p>æœ‰äº›åœºæ™¯ä¸‹ï¼Œç‰¹åˆ«æ˜¯åœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›å°†å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„å€¼çš„æ‰€æœ‰æƒè½¬ç§»åˆ°å…¶ä»–ä¸Šä¸‹æ–‡ä¸­ï¼Œå› æ­¤ç±»ä¼¼äº C&#x2F;C++ ä¸­çš„æŒ‰å¼•ç”¨ä¼ å‚ï¼ŒRustå¯ä»¥ä½¿ç”¨<code>&amp;</code>æˆ–<code>&amp;mut</code>åé¢åŠ ä¸Šå€¼è¢«ç»‘å®šåˆ°çš„å˜é‡çš„åå­—æ¥åˆ†åˆ«ç”Ÿæˆå€¼çš„<em>ä¸å¯å˜å¼•ç”¨</em>å’Œ<em>å¯å˜å¼•ç”¨</em>ï¼Œæˆ‘ä»¬ç§°è¿™äº›å¼•ç”¨åˆ†åˆ«$ä¸å¯å˜&#x2F;å¯å˜$å€Ÿç”¨(Borrow)å®ƒä»¬å¼•ç”¨çš„å€¼ã€‚é¡¾åæ€ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯å˜å¼•ç”¨æ¥ä¿®æ”¹å®ƒå€Ÿç”¨çš„å€¼ï¼Œä½†é€šè¿‡ä¸å¯å˜å¼•ç”¨åˆ™åªèƒ½è¯»å–è€Œä¸èƒ½ä¿®æ”¹ã€‚è¿™äº›å¼•ç”¨åŒæ ·æ˜¯éœ€è¦è¢«ç»‘å®šåˆ°å˜é‡ä¸Šçš„å€¼ï¼Œåªæ˜¯å®ƒä»¬çš„ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ã€‚åœ¨ Rust ä¸­ï¼Œå¼•ç”¨ç±»å‹çš„ä½¿ç”¨éœ€è¦è¢«ç¼–è¯‘å™¨æ£€æŸ¥ï¼Œä½†åœ¨æ•°æ®è¡¨è¾¾ä¸Šï¼Œå’Œ C çš„æŒ‡é’ˆä¸€æ ·å®ƒåªè®°å½•å®ƒå€Ÿç”¨çš„å€¼æ‰€åœ¨çš„åœ°å€ï¼Œå› æ­¤åœ¨å†…å­˜ä¸­å®ƒéšå¹³å°ä¸åŒä»…ä¼šå æ® 4 å­—èŠ‚æˆ– 8 å­—èŠ‚ç©ºé—´</p> <p>æ— è®ºå€¼çš„ç±»å‹æ˜¯å¦æ˜¯å¼•ç”¨ç±»å‹ï¼Œæˆ‘ä»¬éƒ½å®šä¹‰å€¼çš„<strong>ç”Ÿå­˜</strong>(Lifetime)ä¸ºä»£ç æ‰§è¡ŒæœŸé—´è¯¥å€¼å¿…é¡»æŒç»­åˆæ³•çš„ä»£ç åŒºåŸŸé›†åˆï¼Œå¤§æ¦‚å¯ä»¥ç†è§£ä¸ºè¯¥å€¼åœ¨ä»£ç ä¸­çš„å“ªäº›åœ°æ–¹è¢«ç”¨åˆ°äº†ï¼Œç®€å•æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½ç­‰åŒäºæ‹¥æœ‰å®ƒçš„å˜é‡çš„ä½œç”¨åŸŸï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä»å®ƒè¢«ç»‘å®šå¼€å§‹ç›´åˆ°å®ƒçš„æ‹¥æœ‰è€…å˜é‡æœ€åä¸€æ¬¡å‡ºç°æˆ–æ˜¯å®ƒè¢«è§£ç»‘</p> <p>å½“æˆ‘ä»¬ä½¿ç”¨ &amp; å’Œ &amp;mut æ¥å€Ÿç”¨å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç¼–å†™çš„ä»£ç å¿…é¡»æ»¡è¶³æŸäº›çº¦æŸæ¡ä»¶ï¼Œä¸ç„¶æ— æ³•é€šè¿‡ç¼–è¯‘:</p> <ul> <li><p>ä¸å¯å˜&#x2F;å¯å˜å¼•ç”¨çš„ç”Ÿå­˜æœŸä¸èƒ½<strong>è¶…å‡º</strong>(Outlive)å®ƒä»¬å€Ÿç”¨çš„å€¼çš„ç”Ÿå­˜æœŸï¼Œå‰è€…å¿…é¡»æ˜¯åè€…çš„å­é›†</p> </li> <li><p>åŒä¸€æ—¶é—´ï¼Œå€Ÿç”¨åŒä¸€ä¸ªå€¼çš„ä¸å¯å˜å’Œå¯å˜å¼•ç”¨ä¸èƒ½å…±å­˜</p> </li> <li><p>åŒä¸€æ—¶é—´ï¼Œå€Ÿç”¨åŒä¸€ä¸ªå€¼çš„ä¸å¯å˜å¼•ç”¨å¯ä»¥å­˜åœ¨å¤šä¸ªï¼Œä½†å¯å˜å¼•ç”¨åªèƒ½å­˜åœ¨ä¸€ä¸ª</p> </li> </ul> <p>è¿™æ˜¯ä¸ºäº† Rust <strong>å†…å­˜å®‰å…¨</strong>è€Œè®¾è®¡çš„é‡è¦çº¦æŸæ¡ä»¶ã€‚ç¬¬ä¸€æ¡å¾ˆå¥½ç†è§£ï¼Œå¦‚æœå€¼çš„ç”Ÿå­˜æœŸæœªèƒ½å®Œå…¨è¦†ç›–å€Ÿç”¨å®ƒçš„å¼•ç”¨çš„ç”Ÿå­˜æœŸï¼Œå°±ä¼šåœ¨æŸä¸€æ—¶åˆ»å‘ç”Ÿå€¼å·²è¢«é”€æ¯è€Œæˆ‘ä»¬ä»ç„¶å°è¯•é€šè¿‡å¼•ç”¨æ¥è®¿é—®è¯¥å€¼çš„æƒ…å½¢ã€‚åè¿‡æ¥è¯´ï¼Œæ˜¾ç„¶å½“å€¼åˆæ³•æ—¶å¼•ç”¨æ‰æœ‰æ„ä¹‰ã€‚æœ€å…¸å‹çš„ä¾‹å­æ˜¯<strong>æ‚¬å‚æŒ‡é’ˆ</strong>(Dangling Pointer)é—®é¢˜ï¼Œå³æˆ‘ä»¬å°è¯•åœ¨ä¸€ä¸ªå‡½æ•°ä¸­è¿”å›å‡½æ•°ä¸­å£°æ˜çš„å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œå¹¶åœ¨è°ƒç”¨è€…å‡½æ•°ä¸­è¯•å›¾é€šè¿‡è¯¥å¼•ç”¨è®¿é—®<code>å·²è¢«é”€æ¯çš„å±€éƒ¨å˜é‡</code>ï¼Œè¿™ä¼šäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºå¹¶å¯¼è‡´é”™è¯¯ã€‚ç¬¬äºŒï¼Œä¸‰æ¡çš„ä¸»è¦ç›®çš„åˆ™æ˜¯ä¸ºäº†é¿å…é€šè¿‡å¤šä¸ªå¼•ç”¨å¯¹åŒä¸€ä¸ªå€¼è¿›è¡Œçš„è¯»å†™æ“ä½œäº§ç”Ÿå†²çªã€‚ä¾‹å¦‚ï¼Œå½“å¯¹åŒä¸€ä¸ªå€¼çš„è¯»æ“ä½œå’Œå†™æ“ä½œåœ¨æ—¶é—´ä¸Šç›¸äº’äº¤é”™æ—¶(å³ä¸å¯å˜&#x2F;å¯å˜å¼•ç”¨çš„ç”Ÿå­˜æœŸéƒ¨åˆ†é‡å )ï¼Œè¯»æ“ä½œä¾¿æœ‰å¯èƒ½è¯»åˆ°è¢«ä¿®æ”¹åˆ°ä¸€åŠçš„å€¼ï¼Œé€šå¸¸è¿™ä¼šæ˜¯ä¸€ä¸ªä¸åˆæ³•çš„å€¼ä»è€Œå¯¼è‡´ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œã€‚è¿™å¯èƒ½æ˜¯ç”±äºæˆ‘ä»¬åœ¨ç¼–ç¨‹ä¸Šçš„ç–å¿½ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨è¯»å–ä¸€ä¸ªå€¼çš„æ—¶å€™å¿˜è®°å®ƒç›®å‰æ­£å¤„åœ¨è¢«ä¿®æ”¹åˆ°ä¸€åŠçš„çŠ¶æ€ï¼Œä¸€ä¸ªå¯èƒ½çš„ä¾‹å­æ˜¯åœ¨ C++ ä¸­æ­£å¯¹å®¹å™¨è¿›è¡Œè¿­ä»£è®¿é—®çš„æ—¶å€™ä¿®æ”¹äº†å®¹å™¨æœ¬èº«ã€‚ä¹Ÿæœ‰å¯èƒ½è¢«å½’ç»“ä¸º<strong>åˆ«å</strong>(Aliasing)é—®é¢˜ï¼Œä¾‹å¦‚åœ¨ C å‡½æ•°ä¸­æœ‰ä¸¤ä¸ªæŒ‡é’ˆå‚æ•°ï¼Œå¦‚æœå®ƒä»¬æŒ‡å‘ç›¸åŒçš„åœ°å€ä¸”ç¼–è¯‘å™¨æ²¡æœ‰æ³¨æ„åˆ°è¿™ä¸€ç‚¹å°±è¿›è¡Œè¿‡æ¿€çš„ä¼˜åŒ–ï¼Œå°†ä¼šä½¿å¾—ç¼–è¯‘ç»“æœåç¦»æˆ‘ä»¬æœŸæœ›çš„è¯­ä¹‰</p> <p>ä¸Šè¿°çº¦æŸæ¡ä»¶è¦æ±‚å€Ÿç”¨åŒä¸€ä¸ªå€¼çš„ä¸å¯å˜å¼•ç”¨å’Œä¸å¯å˜&#x2F;å¯å˜å¼•ç”¨çš„<code>ç”Ÿå­˜æœŸç›¸äº’éš”ç¦»</code>ï¼Œä»è€Œèƒ½å¤Ÿè§£å†³è¿™äº›é—®é¢˜ã€‚Rust<em>ç¼–è¯‘å™¨</em>ä¼šåœ¨ç¼–è¯‘æ—¶ä½¿ç”¨<strong>å€Ÿç”¨æ£€æŸ¥å™¨</strong>(Borrow Checker)æ£€æŸ¥è¿™äº›çº¦æŸæ¡ä»¶æ˜¯å¦è¢«æ»¡è¶³ã€‚å…¶å…·ä½“åšæ³•æ˜¯å°½å¯èƒ½ç²¾ç¡®çš„ä¼°è®¡å¼•ç”¨å’Œå€¼çš„ç”Ÿå­˜æœŸå¹¶å°†å®ƒä»¬è¿›è¡Œæ¯”è¾ƒã€‚éšç€ Rust è¯­è¨€çš„æ„ˆå‘å®Œå–„ï¼Œå…¶ä¼°è®¡çš„ç²¾ç¡®åº¦ä¹Ÿä¼šè¶Šæ¥è¶Šé«˜ï¼Œä½¿å¾—ç¨‹åºå‘˜èƒ½å¤Ÿæ›´å®¹æ˜“é€šè¿‡å€Ÿç”¨æ£€æŸ¥ã€‚å¼•ç”¨ç›¸å…³çš„å€Ÿç”¨æ£€æŸ¥å‘ç”Ÿåœ¨ç¼–è¯‘æœŸï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç§°å…¶ä¸º<code>ç¼–è¯‘æœŸå€Ÿç”¨æ£€æŸ¥</code></p> <p>ç›¸å¯¹çš„ï¼Œå¯¹å€¼çš„å€Ÿç”¨æ–¹å¼è¿è¡Œæ—¶å¯å˜çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Rust å†…ç½®çš„æ•°æ®ç»“æ„å°†å€Ÿç”¨æ£€æŸ¥æ¨è¿Ÿåˆ°è¿è¡Œæ—¶ï¼Œè¿™å¯ä»¥ç§°ä¸º<strong>è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥</strong>ï¼Œå®ƒçš„çº¦æŸæ¡ä»¶å’Œ<code>ç¼–è¯‘æœŸå€Ÿç”¨æ£€æŸ¥</code>ä¸€è‡´ã€‚å½“æˆ‘ä»¬æƒ³è¦å‘èµ·å€Ÿç”¨æˆ–ç»ˆæ­¢å€Ÿç”¨æ—¶ï¼Œåªéœ€è°ƒç”¨å¯¹åº”æ•°æ®ç»“æ„æä¾›çš„<strong>æ¥å£</strong>å³å¯ã€‚å€¼çš„å€Ÿç”¨çŠ¶æ€ä¼šå ç”¨ä¸€éƒ¨åˆ†é¢å¤–å†…å­˜ï¼Œè¿è¡Œæ—¶è¿˜ä¼šæœ‰é¢å¤–çš„ä»£ç å¯¹å€Ÿç”¨åˆæ³•æ€§è¿›è¡Œæ£€æŸ¥ï¼Œè¿™æ˜¯$ä¸ºæ»¡è¶³å€Ÿç”¨æ–¹å¼çš„çµæ´»æ€§äº§ç”Ÿçš„å¿…è¦å¼€é”€$ã€‚å½“æ— æ³•é€šè¿‡å€Ÿç”¨æ£€æŸ¥æ—¶ï¼Œå°†ä¼šäº§ç”Ÿä¸€ä¸ªä¸å¯æ¢å¤é”™è¯¯ï¼Œå¯¼è‡´ç¨‹åºæ‰“å°é”™è¯¯ä¿¡æ¯å¹¶ç«‹å³é€€å‡ºã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨<strong>RefCell</strong>åŒ…è£¹å¯è¢«å€Ÿç”¨çš„å€¼ï¼Œéšåè°ƒç”¨<code>borrow</code>å’Œ<code>borrow_mut</code>ä¾¿å¯å‘èµ·å€Ÿç”¨å¹¶è·å¾—ä¸€ä¸ªå¯¹å€¼çš„ä¸å¯å˜&#x2F;å¯å˜å€Ÿç”¨çš„æ ‡å¿—ï¼Œå®ƒä»¬å¯ä»¥åƒå¼•ç”¨ä¸€æ ·ä½¿ç”¨ã€‚ä¸ºäº†ç»ˆæ­¢å€Ÿç”¨ï¼Œæˆ‘ä»¬åªéœ€æ‰‹åŠ¨é”€æ¯è¿™äº›æ ‡å¿—æˆ–è€…ç­‰å¾…å®ƒä»¬è¢«è‡ªåŠ¨é”€æ¯~</p> <p>RefCellçš„è¯¦ç»†ç”¨æ³•è¯·å‚è€ƒ:</p> <p><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/std/cell/struct.RefCell.html">https://doc.rust-lang.org/stable/std/cell/struct.RefCell.html</a></p> 
          </div>

<p>å¦‚æœå•ç‹¬ä½¿ç”¨ static è€Œå»æ‰ mut çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å£°æ˜ä¸€ä¸ªåˆå§‹åŒ–ä¹‹åå°±ä¸å¯å˜çš„<em>å…¨å±€å˜é‡</em>ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ AppManager é‡Œé¢çš„å†…å®¹åœ¨è¿è¡Œæ—¶å‘ç”Ÿå˜åŒ–</p>
<p>è¿™æ¶‰åŠåˆ° Rust ä¸­çš„<strong>å†…éƒ¨å¯å˜æ€§</strong>(Interior Mutability)ï¼Œä¹Ÿå³åœ¨å˜é‡è‡ªèº«ä¸å¯å˜æˆ–ä»…åœ¨ä¸å¯å˜å€Ÿç”¨çš„æƒ…å†µä¸‹ä»èƒ½ä¿®æ”¹ç»‘å®šåˆ°å˜é‡ä¸Šçš„å€¼</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”¨ä¸Šé¢æåˆ°çš„ RefCell æ¥åŒ…è£¹AppManagerï¼Œè¿™æ · RefCell æ— éœ€è¢«å£°æ˜ä¸ºmutï¼ŒåŒæ—¶è¢«åŒ…è£¹çš„ AppManager ä¹Ÿèƒ½è¢«ä¿®æ”¹</p>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬èƒ½å¦å°† RefCell å£°æ˜ä¸ºä¸€ä¸ªå…¨å±€å˜é‡å‘¢ï¼Ÿ</p>
<p>è¯•ä¸€è¯•å§â€¦</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=18b0f956b83e6a8a408215edcfcb6d01</span><br><span class="hljs-keyword">use</span> std::cell::RefCell;<br><span class="hljs-keyword">static</span> A: RefCell&lt;<span class="hljs-type">i32</span>&gt; = RefCell::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">3</span>);<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    *A.<span class="hljs-title function_ invoke__">borrow_mut</span>() = <span class="hljs-number">4</span>;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, A.<span class="hljs-title function_ invoke__">borrow</span>());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç»“æœæ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘ï¼ŒæŠ¥é”™:</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs excel">error[<span class="hljs-symbol">E0277</span>]<span class="hljs-symbol">:</span> `RefCell&lt;<span class="hljs-symbol">i32</span>&gt;` cannot be shared between threads safely<br>--&gt; src/main.<span class="hljs-symbol">rs:2</span><span class="hljs-symbol">:1</span><br>|<br><span class="hljs-number">2</span> | static <span class="hljs-symbol">A:</span> RefCell&lt;<span class="hljs-symbol">i32</span>&gt; = RefCe<span class="hljs-symbol">ll:</span><span class="hljs-symbol">:ne</span>w(<span class="hljs-number">3</span>);<br>| ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `RefCell&lt;<span class="hljs-symbol">i32</span>&gt;` cannot be shared between threads safely<br>|<br>= he<span class="hljs-symbol">lp:</span> the trait `Sync` is <span class="hljs-built_in">not</span> implemented for `RefCell&lt;<span class="hljs-symbol">i32</span>&gt;`<br>= no<span class="hljs-symbol">te:</span> shared static variables must have a <span class="hljs-built_in">type</span> that implements `Sync`<br><br>For more information about this error, try `rustc --explain <span class="hljs-symbol">E0277</span>`.<br></code></pre></td></tr></table></figure>

<p>Rustç¼–è¯‘å™¨æç¤ºæˆ‘ä»¬<code>RefCell&lt;i32&gt;</code>æœªè¢«æ ‡è®°ä¸º<code>Sync</code>ï¼Œå› æ­¤ Rust ç¼–è¯‘å™¨è®¤ä¸ºå®ƒä¸èƒ½è¢«å®‰å…¨çš„åœ¨<strong>çº¿ç¨‹</strong>é—´å…±äº«ï¼Œä¹Ÿå°±ä¸èƒ½ä½œä¸ºå…¨å±€å˜é‡ä½¿ç”¨</p>
<p>ä½†æ˜¯ï¼Œæç¬‘å‘¢ï¼Œæˆ‘ä»¬è¿™åªæ˜¯ä¸€ä¸ªå•çº¿ç¨‹ç¨‹åºï¼Œæ²¡æœ‰ä»»ä½•çº¿ç¨‹é—´å…±äº«æ•°æ®çš„è¡Œä¸ºï¼Œä¸ºä»€ä¹ˆä¸èƒ½é€šè¿‡ç¼–è¯‘å‘¢</p>
<p>åŸæ¥ï¼ŒRustå¯¹äº<strong>å¹¶å‘å®‰å…¨</strong>çš„æ£€æŸ¥è¾ƒä¸ºç²—ç³™ï¼Œå½“å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼š$é»˜è®¤$ç¨‹åºå‘˜ä¼šåœ¨<code>å¤šçº¿ç¨‹</code>ä¸Šä½¿ç”¨å®ƒï¼Œè€Œå¹¶ä¸ä¼šæ£€æŸ¥ç¨‹åºå‘˜æ˜¯å¦çœŸçš„è¿™æ ·åš</p>
<p>å¦‚æœä¸€ä¸ªå˜é‡å®é™…ä¸Šä»…ä¼šåœ¨å•çº¿ç¨‹ä¸Šä½¿ç”¨ï¼Œé‚£ Rust ä¼šæœŸå¾…æˆ‘ä»¬å°†å˜é‡åˆ†é…åœ¨<code>æ ˆ</code>ä¸Šä½œä¸º<strong>å±€éƒ¨å˜é‡</strong>è€Œä¸æ˜¯å…¨å±€å˜é‡</p>
<p>ä½†æ˜¯æ˜¾ç„¶è¿™ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚</p>
<p>æ€ä¹ˆåŠå‘¢?</p>
<p>æˆ‘ä»¬åœ¨ RefCell çš„åŸºç¡€ä¸Šå†$å°è£…$ä¸€ä¸ªUPSafeCellï¼Œä»è€Œå…è®¸æˆ‘ä»¬åœ¨<strong>å•æ ¸</strong>ä¸Šå®‰å…¨ä½¿ç”¨å¯å˜å…¨å±€å˜é‡</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/sync/up.rs</span><br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">UPSafeCell</span>&lt;T&gt; &#123;<br>    <span class="hljs-comment">/// inner data</span><br>    inner: RefCell&lt;T&gt;,<br>&#125;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span>&lt;T&gt; <span class="hljs-built_in">Sync</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">UPSafeCell</span>&lt;T&gt; &#123;&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; UPSafeCell&lt;T&gt; &#123;<br>    <span class="hljs-comment">/// User is responsible to guarantee that inner struct is only used in</span><br>    <span class="hljs-comment">/// uniprocessor.</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(value: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123; inner: RefCell::<span class="hljs-title function_ invoke__">new</span>(value) &#125;<br>    &#125;<br>    <span class="hljs-comment">/// Panic if the data has been borrowed.</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">exclusive_access</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RefMut&lt;<span class="hljs-symbol">&#x27;_</span>, T&gt; &#123;<br>        <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">borrow_mut</span>()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ ·å½“æˆ‘ä»¬è¦è®¿é—®æ•°æ®æ—¶(æ— è®ºè¯»è¿˜æ˜¯å†™)ï¼Œéœ€è¦é¦–å…ˆè°ƒç”¨<code>exclusive_access</code>è·å¾—æ•°æ®çš„å¯å˜å€Ÿç”¨æ ‡è®°ï¼Œé€šè¿‡å®ƒå¯ä»¥å®Œæˆæ•°æ®çš„è¯»å†™</p>
<p>åœ¨æ“ä½œå®Œæˆä¹‹åæˆ‘ä»¬éœ€è¦<code>é”€æ¯</code>è¿™ä¸ªæ ‡è®°ï¼Œæ­¤åæ‰èƒ½å¼€å§‹å¯¹è¯¥æ•°æ®çš„ä¸‹ä¸€æ¬¡è®¿é—®~</p>
<div class="note note-danger">
            <p>è‡ªå·±æ³¨æ„ä¸€ä¸‹<strong>unsafe</strong>æ“ä½œ ğŸ¤¨</p> 
          </div>

<p>ç°åœ¨æˆ‘ä»¬å°±èƒ½ä»¥<em>å°½é‡å°‘</em>çš„<code>unsafe code</code>æ¥åˆå§‹åŒ–AppManagerçš„å…¨å±€å®ä¾‹<code>APP_MANAGER</code>äº†!</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/batch.rs</span><br><br>lazy_static! &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> APP_MANAGER: UPSafeCell&lt;AppManager&gt; = <span class="hljs-keyword">unsafe</span> &#123; UPSafeCell::<span class="hljs-title function_ invoke__">new</span>(&#123;<br>        <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123; <span class="hljs-keyword">fn</span> <span class="hljs-title function_">_num_app</span>(); &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">num_app_ptr</span> = _num_app <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">usize</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">num_app</span> = num_app_ptr.<span class="hljs-title function_ invoke__">read_volatile</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">app_start</span>: [<span class="hljs-type">usize</span>; MAX_APP_NUM + <span class="hljs-number">1</span>] = [<span class="hljs-number">0</span>; MAX_APP_NUM + <span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">app_start_raw</span>: &amp;[<span class="hljs-type">usize</span>] =  core::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(<br>            num_app_ptr.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">1</span>), num_app + <span class="hljs-number">1</span><br>        );<br>        app_start[..=num_app].<span class="hljs-title function_ invoke__">copy_from_slice</span>(app_start_raw);<br>        AppManager &#123;<br>            num_app,<br>            current_app: <span class="hljs-number">0</span>,<br>            app_start,<br>        &#125;<br>    &#125;)&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå…¨å±€å˜é‡å¿…é¡»åœ¨ç¼–è¯‘æœŸè®¾ç½®ä¸€ä¸ªåˆå§‹å€¼ï¼Œä½†æ˜¯æœ‰äº›å…¨å±€å˜é‡ä¾èµ–äºè¿è¡ŒæœŸé—´æ‰èƒ½å¾—åˆ°çš„æ•°æ®ä½œä¸ºåˆå§‹å€¼ï¼Œè¿™å¯¼è‡´è¿™äº›å…¨å±€å˜é‡éœ€è¦åœ¨è¿è¡Œæ—¶å‘ç”Ÿå˜åŒ–ï¼Œå³éœ€è¦é‡æ–°è®¾ç½®åˆå§‹å€¼ä¹‹åæ‰èƒ½ä½¿ç”¨</p>
<p>å› æ­¤æˆ‘ä»¬ä½¿ç”¨<code>lazy_static!</code>å®ä»¥å®ç°å…¨å±€å˜é‡çš„è¿è¡Œæ—¶åˆå§‹åŒ–åŠŸèƒ½</p>
<p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># os/Cargo.toml</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">lazy_static</span> = &#123; version = <span class="hljs-string">&quot;1.4.0&quot;</span>, features = [<span class="hljs-string">&quot;spin_no_std&quot;</span>] &#125;<br></code></pre></td></tr></table></figure>

<p>AppManagerçš„æ–¹æ³•ä¸­ï¼Œæœ‰<code>print_app_info</code>&#x2F;<code>get_current_app</code>&#x2F;<code>move_to_next_app</code>ï¼Œéƒ½æ˜¯å­—é¢æ„æ€ï¼Œè§ä¸‹</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_app_info</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;there are &#123;&#125; apps totally!!!&quot;</span>, <span class="hljs-keyword">self</span>.num_app);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-keyword">self</span>.num_app &#123;<br>        <span class="hljs-built_in">println!</span>(<br>            <span class="hljs-string">&quot;[kernel] app_&#123;&#125; range [&#123;:#x&#125;, &#123;:#x&#125;)!&quot;</span>,<br>            i,<br>            <span class="hljs-keyword">self</span>.app_start[i],<br>            <span class="hljs-keyword">self</span>.app_start[i + <span class="hljs-number">1</span>]<br>        );<br>    &#125;<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_current_app</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    <span class="hljs-keyword">self</span>.current_app<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">move_to_next_app</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">self</span>.current_app += <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹<code>load_app</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">load_app</span>(&amp;<span class="hljs-keyword">self</span>, app_id: <span class="hljs-type">usize</span>) &#123;<br>    <span class="hljs-keyword">if</span> app_id &gt;= <span class="hljs-keyword">self</span>.num_app &#123;<br>        <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;All applications completed!&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[kernel] Loading app_&#123;&#125;&quot;</span>, app_id);<br>    <span class="hljs-comment">// clear app area</span><br>    core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(<br>        APP_BASE_ADDRESS <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>,<br>        APP_SIZE_LIMIT<br>    ).<span class="hljs-title function_ invoke__">fill</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app_src</span> = core::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(<br>        <span class="hljs-keyword">self</span>.app_start[app_id] <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>,<br>        <span class="hljs-keyword">self</span>.app_start[app_id + <span class="hljs-number">1</span>] - <span class="hljs-keyword">self</span>.app_start[app_id]<br>    );<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">app_dst</span> = core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(<br>        APP_BASE_ADDRESS <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>,<br>        app_src.<span class="hljs-title function_ invoke__">len</span>()<br>    );<br>    app_dst.<span class="hljs-title function_ invoke__">copy_from_slice</span>(app_src);<br>    <span class="hljs-comment">// memory fence about fetching the instruction memory</span><br>    asm!(<span class="hljs-string">&quot;fence.i&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é¦–å…ˆå°†ä¸€å—å†…å­˜æ¸…ç©ºï¼Œç„¶åæ‰¾åˆ°å¾…åŠ è½½åº”ç”¨äºŒè¿›åˆ¶é•œåƒçš„ä½ç½®ï¼Œå¹¶å°†å®ƒå¤åˆ¶åˆ°æ­£ç¡®çš„ä½ç½®</p>
<p>å®ƒæœ¬è´¨ä¸Šæ˜¯æŠŠæ•°æ®ä»ä¸€å—å†…å­˜å¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜</p>
<p>åœ¨è¿™ä¸€ç‚¹ä¸Šä¹Ÿä½“ç°äº†å†¯è¯ºä¾æ›¼è®¡ç®—æœºçš„<strong>ä»£ç å³æ•°æ®</strong>çš„ç‰¹å¾!</p>
<p>é‚£è¿™ä¸ªç¥ç§˜çš„<code>fence.i</code>èµ·åˆ°ä»€ä¹ˆä½œç”¨å‘¢?</p>
<p>æˆ‘ä»¬çŸ¥é“<strong>ç¼“å­˜</strong>æ˜¯å­˜å‚¨å±‚çº§ç»“æ„ä¸­æé«˜è®¿å­˜é€Ÿåº¦çš„å¾ˆé‡è¦ä¸€ç¯</p>
<p>è€Œ CPU å¯¹ç‰©ç†å†…å­˜æ‰€åšçš„ç¼“å­˜åˆåˆ†æˆ<em>æ•°æ®ç¼“å­˜</em>(d-cache)å’Œ<em>æŒ‡ä»¤ç¼“å­˜</em>(i-cache)ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«åœ¨ CPU è®¿å­˜å’Œå–æŒ‡çš„æ—¶å€™ä½¿ç”¨</p>
<p>åœ¨å–æŒ‡çš„æ—¶å€™ï¼Œå¯¹äºä¸€ä¸ªæŒ‡ä»¤åœ°å€ï¼ŒCPUä¼šå…ˆå»<code>i-cache</code>é‡Œé¢çœ‹ä¸€ä¸‹å®ƒæ˜¯å¦åœ¨æŸä¸ªå·²ç¼“å­˜çš„<strong>ç¼“å­˜è¡Œ</strong>å†…ï¼Œå¦‚æœåœ¨çš„è¯å®ƒå°±ä¼šç›´æ¥ä»é«˜é€Ÿç¼“å­˜ä¸­æ‹¿åˆ°æŒ‡ä»¤è€Œä¸æ˜¯é€šè¿‡æ€»çº¿è®¿é—®å†…å­˜(æ€§èƒ½ é€Ÿåº¦)</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒCPUä¼šè®¤ä¸ºç¨‹åºçš„ä»£ç æ®µä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤<code>i-cache</code>æ˜¯ä¸€ç§<strong>åªè¯»ç¼“å­˜</strong></p>
<p>ä½†åœ¨è¿™é‡Œï¼ŒOSå°†ä¿®æ”¹ä¼šè¢« CPU å–æŒ‡çš„å†…å­˜åŒºåŸŸï¼Œè¿™ä¼šä½¿å¾— i-cache ä¸­å«æœ‰ä¸å†…å­˜ä¸­ä¸ä¸€è‡´çš„å†…å®¹</p>
<p>å› æ­¤ï¼ŒOSåœ¨è¿™é‡Œå¿…é¡»ä½¿ç”¨<strong>å–æŒ‡å±éšœæŒ‡ä»¤</strong><code>fence.i</code></p>
<p>å®ƒçš„åŠŸèƒ½æ˜¯ä¿è¯<strong>åœ¨å®ƒä¹‹åçš„å–æŒ‡è¿‡ç¨‹å¿…é¡»èƒ½å¤Ÿçœ‹åˆ°åœ¨å®ƒä¹‹å‰çš„æ‰€æœ‰å¯¹äºå–æŒ‡å†…å­˜åŒºåŸŸçš„ä¿®æ”¹</strong></p>
<p>è¿™æ ·æ‰èƒ½ä¿è¯ CPU è®¿é—®çš„åº”ç”¨ä»£ç æ˜¯æœ€æ–°çš„è€Œä¸æ˜¯<code>i-cache</code>ä¸­è¿‡æ—¶çš„å†…å®¹</p>
<p>è‡³äºç¡¬ä»¶æ˜¯å¦‚ä½•å®ç°<code>fence.i</code>è¿™æ¡æŒ‡ä»¤çš„ï¼Œè¿™ä¸€ç‚¹æ¯ä¸ªç¡¬ä»¶çš„å…·ä½“å®ç°æ–¹å¼éƒ½å¯èƒ½ä¸åŒï¼Œæ¯”å¦‚ç›´æ¥æ¸…ç©º<code>i-cache</code>ä¸­æ‰€æœ‰å†…å®¹æˆ–è€…æ ‡è®°å…¶ä¸­æŸäº›å†…å®¹ä¸åˆæ³•ç­‰ç­‰â€¦</p>
<p>æœ€åï¼Œæˆ‘ä»¬åœ¨<code>batch</code>å­æ¨¡å—å¯¹å¤–æš´éœ²å‡ºå¦‚ä¸‹æ¥å£:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// init batch subsystem</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>() &#123;<br>    <span class="hljs-title function_ invoke__">print_app_info</span>();<br>&#125;<br><br><span class="hljs-comment">/// print apps info</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_app_info</span>() &#123;<br>    APP_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>().<span class="hljs-title function_ invoke__">print_app_info</span>();<br>&#125;<br><br><span class="hljs-comment">/// run next app</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_next_app</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">app_manager</span> = APP_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">current_app</span> = app_manager.<span class="hljs-title function_ invoke__">get_current_app</span>();<br>    app_manager.<span class="hljs-title function_ invoke__">load_app</span>(current_app);<br>    app_manager.<span class="hljs-title function_ invoke__">move_to_next_app</span>();<br>    <span class="hljs-title function_ invoke__">drop</span>(app_manager);<br>    <span class="hljs-comment">// before this we have to drop local variables related to resources manually</span><br>    <span class="hljs-comment">// and release the resources</span><br>    <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__restore</span>(cx_addr: <span class="hljs-type">usize</span>);<br>    &#125;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        __restore(KERNEL_STACK.<span class="hljs-title function_ invoke__">push_context</span>(TrapContext::<span class="hljs-title function_ invoke__">app_init_context</span>(<br>            APP_BASE_ADDRESS,<br>            USER_STACK.<span class="hljs-title function_ invoke__">get_sp</span>(),<br>            )) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> _ <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>    &#125;<br>    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unreachable in batch::run_current_app!!!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="å®ç°ç‰¹æƒçº§çš„åˆ‡æ¢"><a href="#å®ç°ç‰¹æƒçº§çš„åˆ‡æ¢" class="headerlink" title="å®ç°ç‰¹æƒçº§çš„åˆ‡æ¢"></a>å®ç°ç‰¹æƒçº§çš„åˆ‡æ¢</h2><p>æœ€åï¼Œæˆ‘ä»¬æ¥å®ç°<code>ç‰¹æƒçº§çš„åˆ‡æ¢</code>!</p>
<p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·æ€ç‰¹æƒçº§è¿è¡Œæ—¶ï¼Œæ— æ³•ç›´æ¥é€šè¿‡<code>å‡½æ•°è°ƒç”¨</code>è®¿é—®å¤„äºå†…æ ¸æ€ç‰¹æƒçº§çš„æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„å‡½æ•°</p>
<p>ä½†åº”ç”¨ç¨‹åºåˆéœ€è¦å¾—åˆ°æ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºä¸æ“ä½œç³»ç»Ÿéœ€è¦é€šè¿‡æŸç§<code>åˆä½œæœºåˆ¶</code>å®Œæˆç‰¹æƒçº§ä¹‹é—´çš„åˆ‡æ¢ï¼Œä½¿å¾—ç”¨æˆ·æ€åº”ç”¨ç¨‹åºå¯ä»¥å¾—åˆ°å†…æ ¸æ€æ“ä½œç³»ç»Ÿå‡½æ•°çš„æœåŠ¡</p>
<p>æˆ‘ä»¬è‡³å°‘è¦åšåˆ°:</p>
<ul>
<li><p>å½“å¯åŠ¨åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œéœ€è¦åˆå§‹åŒ–åº”ç”¨ç¨‹åºçš„ç”¨æˆ·æ€ä¸Šä¸‹æ–‡ï¼Œå¹¶èƒ½åˆ‡æ¢åˆ°ç”¨æˆ·æ€æ‰§è¡Œåº”ç”¨ç¨‹åº</p>
</li>
<li><p>å½“åº”ç”¨ç¨‹åºå‘èµ·ç³»ç»Ÿè°ƒç”¨(<code>Trap</code>)ä¹‹åï¼Œéœ€è¦åˆ°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸­è¿›è¡Œå¤„ç†</p>
</li>
<li><p>å½“åº”ç”¨ç¨‹åºæ‰§è¡Œå‡ºé”™çš„æ—¶å€™ï¼Œéœ€è¦åˆ°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸­æ€æ­»è¯¥åº”ç”¨å¹¶åŠ è½½è¿è¡Œä¸‹ä¸€ä¸ªåº”ç”¨</p>
</li>
<li><p>å½“åº”ç”¨ç¨‹åºæ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œéœ€è¦åˆ°æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿä¸­åŠ è½½è¿è¡Œä¸‹ä¸€ä¸ªåº”ç”¨(å®é™…ä¸Šå°±æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>sys_exit</code>æ¥å®ç°çš„)</p>
</li>
</ul>
<p>ps: åœ¨<em>introduction</em>ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†<strong>å¯„å­˜å™¨</strong>ç›¸å…³çŸ¥è¯†</p>
<p>åœ¨Trapè§¦å‘çš„ä¸€ç¬é—´ï¼ŒCPUå°±ä¼šåˆ‡æ¢åˆ° S ç‰¹æƒçº§å¹¶è·³è½¬åˆ°<code>stvec</code>æ‰€æŒ‡ç¤ºçš„ä½ç½®</p>
<p>ä½†æ˜¯åœ¨æ­£å¼è¿›å…¥ S ç‰¹æƒçº§çš„ Trap å¤„ç†ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»<strong>ä¿å­˜åŸæ§åˆ¶æµçš„å¯„å­˜å™¨çŠ¶æ€</strong></p>
<p>è¿™ä¸€èˆ¬é€šè¿‡<strong>å†…æ ¸æ ˆ</strong>æ¥ä¿å­˜</p>
<p>è‡³äºä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨<code>ç”¨æˆ·æ ˆ</code>å‘¢?</p>
<p>ä¸»è¦æ˜¯ä¸ºäº†<strong>å®‰å…¨æ€§</strong>:å¦‚æœä¸¤ä¸ªæ§åˆ¶æµ(å³åº”ç”¨ç¨‹åºçš„æ§åˆ¶æµå’Œå†…æ ¸çš„æ§åˆ¶æµ)ä½¿ç”¨åŒä¸€ä¸ªæ ˆï¼Œåœ¨è¿”å›ä¹‹ååº”ç”¨ç¨‹åºå°±èƒ½è¯»åˆ° Trap æ§åˆ¶æµçš„å†å²ä¿¡æ¯ï¼Œæ¯”å¦‚å†…æ ¸ä¸€äº›å‡½æ•°çš„åœ°å€ï¼Œè¿™æ ·ä¼šå¸¦æ¥å®‰å…¨éšæ‚£~</p>
<p>æˆ‘ä»¬å£°æ˜ä¸¤ä¸ªç±»å‹<code>KernelStack</code>å’Œ<code>UserStack</code>åˆ†åˆ«è¡¨ç¤º<code>å†…æ ¸æ ˆ</code>å’Œ<code>ç”¨æˆ·æ ˆ</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/batch.rs</span><br><br><span class="hljs-keyword">const</span> USER_STACK_SIZE: <span class="hljs-type">usize</span> = <span class="hljs-number">4096</span> * <span class="hljs-number">2</span>;<br><span class="hljs-keyword">const</span> KERNEL_STACK_SIZE: <span class="hljs-type">usize</span> = <span class="hljs-number">4096</span> * <span class="hljs-number">2</span>;<br><br><span class="hljs-meta">#[repr(align(4096))]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">KernelStack</span> &#123;<br>    data: [<span class="hljs-type">u8</span>; KERNEL_STACK_SIZE],<br>&#125;<br><br><span class="hljs-meta">#[repr(align(4096))]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserStack</span> &#123;<br>    data: [<span class="hljs-type">u8</span>; USER_STACK_SIZE],<br>&#125;<br><br><span class="hljs-keyword">static</span> KERNEL_STACK: KernelStack = KernelStack &#123; data: [<span class="hljs-number">0</span>; KERNEL_STACK_SIZE] &#125;;<br><span class="hljs-keyword">static</span> USER_STACK: UserStack = UserStack &#123; data: [<span class="hljs-number">0</span>; USER_STACK_SIZE] &#125;;<br></code></pre></td></tr></table></figure>

<p>äºŒè€…çš„å¤§å°å‡ä¸º$8KiB$ï¼Œä¸”ä»¥å…¨å±€å˜é‡çš„å½¢å¼å®ä¾‹åŒ–åœ¨æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿçš„<code>.bss</code>æ®µä¸­</p>
<p>åŒæ—¶ä¸ºä¸¤ä¸ªç±»å‹å®ç°<code>get_sp</code>æ–¹æ³•æ¥è·å–æ ˆé¡¶åœ°å€:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">KernelStack</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_sp</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.data.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> + KERNEL_STACK_SIZE<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">push_context</span>(&amp;<span class="hljs-keyword">self</span>, cx: TrapContext) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> TrapContext &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">cx_ptr</span> = (<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_sp</span>() - core::mem::size_of::&lt;TrapContext&gt;()) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> TrapContext;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            *cx_ptr = cx;<br>        &#125;<br>        <span class="hljs-keyword">unsafe</span> &#123; cx_ptr.<span class="hljs-title function_ invoke__">as_mut</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">UserStack</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_sp</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.data.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> + USER_STACK_SIZE<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>äºæ˜¯<strong>æ¢æ ˆ</strong>åªéœ€å°†<code>sp</code>å¯„å­˜å™¨çš„å€¼ä¿®æ”¹ä¸º<code>get_sp</code>çš„è¿”å›å€¼å³å¯!</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å®šä¹‰<code>Trap</code>ä¸Šä¸‹æ–‡:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/trap/context.rs</span><br><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TrapContext</span> &#123;<br>    <span class="hljs-keyword">pub</span> x: [<span class="hljs-type">usize</span>; <span class="hljs-number">32</span>],<br>    <span class="hljs-keyword">pub</span> sstatus: Sstatus,<br>    <span class="hljs-keyword">pub</span> sepc: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‡ç‚¹ä¿å­˜é€šç”¨å¯„å­˜å™¨<code>x0~x31</code>ï¼Œ<code>sstatus</code>ä¸<code>sepc</code></p>
<p>ç°åœ¨æ¥å…·ä½“å®ç° Trap ä¸Šä¸‹æ–‡ä¿å­˜å’Œæ¢å¤çš„æ±‡ç¼–ä»£ç </p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹<code>stvec</code>å¯„å­˜å™¨ï¼Œä½¿å…¶æŒ‡å‘æ­£ç¡®çš„ Trap å¤„ç†å…¥å£ç‚¹</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/trap/mod.rs</span><br><br>global_asm!(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;trap.S&quot;</span>));<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>() &#123;<br>    <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123; <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__alltraps</span>(); &#125;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        stvec::<span class="hljs-title function_ invoke__">write</span>(__alltraps <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, TrapMode::Direct);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯<code>__alltraps</code>çš„å®ç°ï¼ŒæŒºå¥½ç†è§£çš„~</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs asm"># os/src/trap/trap.S<br><br>.macro SAVE_GP n<br>    sd x\n, \n*8(sp)<br>.endm<br><br>.align 2<br>__alltraps:<br>    csrrw sp, sscratch, sp<br>    # now sp-&gt;kernel stack, sscratch-&gt;user stack<br>    # allocate a TrapContext on kernel stack<br>    addi sp, sp, -34*8<br>    # save general-purpose registers<br>    sd x1, 1*8(sp)<br>    # skip sp(x2), we will save it later<br>    sd x3, 3*8(sp)<br>    # skip tp(x4), application does not use it<br>    # save x5~x31<br>    .set n, 5<br>    .rept 27<br>        SAVE_GP %n<br>        .set n, n+1<br>    .endr<br>    # we can use t0/t1/t2 freely, because they were saved on kernel stack<br>    csrr t0, sstatus<br>    csrr t1, sepc<br>    sd t0, 32*8(sp)<br>    sd t1, 33*8(sp)<br>    # read user stack from sscratch and save it on the kernel stack<br>    csrr t2, sscratch<br>    sd t2, 2*8(sp)<br>    # set input argument of trap_handler(cx: &amp;mut TrapContext)<br>    mv a0, sp<br>    call trap_handler<br></code></pre></td></tr></table></figure>

<div class="note note-success">
            <p>tips: <em>CSR</em>ç›¸å…³<strong>åŸå­æŒ‡ä»¤</strong>:</p> <p>RISC-Vä¸­è¯»å†™CSRçš„æŒ‡ä»¤æ˜¯ä¸€ç±»èƒ½ä¸ä¼šè¢«æ‰“æ–­åœ°å®Œæˆå¤šä¸ªè¯»å†™æ“ä½œçš„æŒ‡ä»¤</p> <p>è¿™ç§ä¸ä¼šè¢«æ‰“æ–­åœ°å®Œæˆå¤šä¸ªæ“ä½œçš„æŒ‡ä»¤è¢«ç§°ä¸º<strong>åŸå­æŒ‡ä»¤</strong>(Atomic Instruction)ï¼Œè¿™é‡Œ<code>åŸå­</code>çš„å«ä¹‰æ˜¯â€œä¸å¯åˆ†å‰²çš„æœ€å°ä¸ªä½“â€ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡ä»¤çš„å¤šä¸ªæ“ä½œè¦ä¹ˆéƒ½ä¸å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè€Œä¸ä¼šå¤„äºæŸç§ä¸­é—´çŠ¶æ€</p> <p>å¦å¤–ï¼ŒRISC-Væ¶æ„ä¸­å¸¸è§„çš„æ•°æ®å¤„ç†å’Œè®¿å­˜ç±»æŒ‡ä»¤åªèƒ½æ“ä½œé€šç”¨å¯„å­˜å™¨è€Œä¸èƒ½æ“ä½œCSR</p> <p>å› æ­¤ï¼Œå½“æƒ³è¦å¯¹CSRè¿›è¡Œæ“ä½œæ—¶ï¼Œéœ€è¦å…ˆä½¿ç”¨è¯»å–CSRçš„æŒ‡ä»¤å°†CSRè¯»åˆ°ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ï¼Œè€Œåæ“ä½œè¯¥é€šç”¨å¯„å­˜å™¨ï¼Œæœ€åå†ä½¿ç”¨å†™å…¥CSRçš„æŒ‡ä»¤å°†è¯¥é€šç”¨å¯„å­˜å™¨çš„å€¼å†™å…¥åˆ°CSRä¸­!</p> 
          </div>

<p>å½“<code>trap_handler</code>è¿”å›ä¹‹ååˆ™ä¼šä»è°ƒç”¨trap_handlerçš„ä¸‹ä¸€æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„<code>__restore</code>!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs asm"># os/src/trap/trap.S<br><br>.macro LOAD_GP n<br>    ld x\n, \n*8(sp)<br>.endm<br><br>__restore:<br>    # case1: start running app by __restore<br>    # case2: back to U after handling trap<br>    mv sp, a0<br>    # now sp-&gt;kernel stack(after allocated), sscratch-&gt;user stack<br>    # restore sstatus/sepc<br>    ld t0, 32*8(sp)<br>    ld t1, 33*8(sp)<br>    ld t2, 2*8(sp)<br>    csrw sstatus, t0<br>    csrw sepc, t1<br>    csrw sscratch, t2<br>    # restore general-purpuse registers except sp/tp<br>    ld x1, 1*8(sp)<br>    ld x3, 3*8(sp)<br>    .set n, 5<br>    .rept 27<br>        LOAD_GP %n<br>        .set n, n+1<br>    .endr<br>    # release TrapContext on kernel stack<br>    addi sp, sp, 34*8<br>    # now sp-&gt;kernel stack, sscratch-&gt;user stack<br>    csrrw sp, sscratch, sp<br>    sret<br></code></pre></td></tr></table></figure>

<p>ä¾æ—§å¾ˆå¥½ç†è§£</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨Rustå®ç°<code>trap_handler</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/trap/mod.rs</span><br><br><span class="hljs-meta">#[no_mangle]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">trap_handler</span>(cx: &amp;<span class="hljs-keyword">mut</span> TrapContext) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> TrapContext &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">scause</span> = scause::<span class="hljs-title function_ invoke__">read</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">stval</span> = stval::<span class="hljs-title function_ invoke__">read</span>();<br>    <span class="hljs-keyword">match</span> scause.<span class="hljs-title function_ invoke__">cause</span>() &#123;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::UserEnvCall) =&gt; &#123;<br>            cx.sepc += <span class="hljs-number">4</span>;<br>            cx.x[<span class="hljs-number">10</span>] = <span class="hljs-title function_ invoke__">syscall</span>(cx.x[<span class="hljs-number">17</span>], [cx.x[<span class="hljs-number">10</span>], cx.x[<span class="hljs-number">11</span>], cx.x[<span class="hljs-number">12</span>]]) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::StoreFault) |<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::StorePageFault) =&gt; &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[kernel] PageFault in application, kernel killed it.&quot;</span>);<br>            <span class="hljs-title function_ invoke__">run_next_app</span>();<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::IllegalInstruction) =&gt; &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[kernel] IllegalInstruction in application, kernel killed it.&quot;</span>);<br>            <span class="hljs-title function_ invoke__">run_next_app</span>();<br>        &#125;<br>        _ =&gt; &#123;<br>            <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unsupported trap &#123;:?&#125;, stval = &#123;:#x&#125;!&quot;</span>, scause.<span class="hljs-title function_ invoke__">cause</span>(), stval);<br>        &#125;<br>    &#125;<br>    cx<br>&#125;<br></code></pre></td></tr></table></figure>

<p>éœ€è¦å¼•å…¥ä¾èµ–</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># os/Cargo.toml</span><br><br><span class="hljs-section">[dependencies]</span><br><span class="hljs-attr">riscv</span> = &#123; git = <span class="hljs-string">&quot;https://github.com/rcore-os/riscv&quot;</span>, features = [<span class="hljs-string">&quot;inline-asm&quot;</span>] &#125;<br></code></pre></td></tr></table></figure>

<p>syscallå‡½æ•°å¹¶ä¸ä¼šå®é™…å¤„ç†ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œåªæ˜¯æ ¹æ®<code>syscall ID</code>åˆ†å‘åˆ°å…·ä½“çš„å¤„ç†å‡½æ•°:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/syscall/mod.rs</span><br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">syscall</span>(syscall_id: <span class="hljs-type">usize</span>, args: [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">match</span> syscall_id &#123;<br>        SYSCALL_WRITE =&gt; <span class="hljs-title function_ invoke__">sys_write</span>(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>] <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>, args[<span class="hljs-number">2</span>]),<br>        SYSCALL_EXIT =&gt; <span class="hljs-title function_ invoke__">sys_exit</span>(args[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span>),<br>        _ =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unsupported syscall_id: &#123;&#125;&quot;</span>, syscall_id),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¹¶å°†ä¼ è¿›æ¥çš„å‚æ•°<code>args</code>è½¬åŒ–æˆèƒ½å¤Ÿè¢«å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°æ¥å—çš„ç±»å‹</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/syscall/fs.rs</span><br><br><span class="hljs-keyword">const</span> FD_STDOUT: <span class="hljs-type">usize</span> = <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_write</span>(fd: <span class="hljs-type">usize</span>, buf: *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>, len: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">match</span> fd &#123;<br>        FD_STDOUT =&gt; &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">slice</span> = <span class="hljs-keyword">unsafe</span> &#123; core::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(buf, len) &#125;;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">str</span> = core::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(slice).<span class="hljs-title function_ invoke__">unwrap</span>();<br>            <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, <span class="hljs-type">str</span>);<br>            len <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span><br>        &#125;,<br>        _ =&gt; &#123;<br>            <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unsupported fd in sys_write!&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// os/src/syscall/process.rs</span><br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_exit</span>(xstate: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[kernel] Application exited with code &#123;&#125;&quot;</span>, xstate);<br>    <span class="hljs-title function_ invoke__">run_next_app</span>()<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æœ€åï¼Œæˆ‘ä»¬å°†å…ˆå‰æ„å»ºçš„æ“ä½œç³»ç»Ÿä¸åº”ç”¨ç¨‹åºå…¨éƒ½<code>ä¸²è”</code>èµ·æ¥!</p>
<p>æµç¨‹å¤§è‡´æ˜¯:</p>
<p>å¯åŠ¨QEMU(é€šç”µè‡ªæ£€) -&gt; å›ºä»¶(firmware UEFI&#x2F;BIOS) -&gt; bootloader -&gt; os -&gt; user apps</p>
<p>ä¸‹é¢æ˜¯ä¸ºå¯åŠ¨åº”ç”¨ç¨‹åºè€Œç‰¹æ®Šæ„é€ çš„ Trap ä¸Šä¸‹æ–‡:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/trap/context.rs</span><br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">TrapContext</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">set_sp</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, sp: <span class="hljs-type">usize</span>) &#123; <span class="hljs-keyword">self</span>.x[<span class="hljs-number">2</span>] = sp; &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">app_init_context</span>(entry: <span class="hljs-type">usize</span>, sp: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">sstatus</span> = sstatus::<span class="hljs-title function_ invoke__">read</span>();<br>        sstatus.<span class="hljs-title function_ invoke__">set_spp</span>(SPP::User);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cx</span> = <span class="hljs-keyword">Self</span> &#123;<br>            x: [<span class="hljs-number">0</span>; <span class="hljs-number">32</span>],<br>            sstatus,<br>            sepc: entry,<br>        &#125;;<br>        cx.<span class="hljs-title function_ invoke__">set_sp</span>(sp);<br>        cx<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨å†…æ ¸æ ˆä¸Šå‹å…¥ä¸Šè¿°Trapä¸Šä¸‹æ–‡ï¼Œå…¶<code>sepc</code>æ˜¯åº”ç”¨ç¨‹åºå…¥å£åœ°å€<code>0x80400000</code>ï¼Œå…¶<code>sp</code>å¯„å­˜å™¨æŒ‡å‘ç”¨æˆ·æ ˆï¼Œå…¶<code>sstatus</code>çš„<code>SPP</code>å­—æ®µè¢«è®¾ç½®ä¸ºUser</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/batch.rs</span><br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_next_app</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">app_manager</span> = APP_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">current_app</span> = app_manager.<span class="hljs-title function_ invoke__">get_current_app</span>();<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        app_manager.<span class="hljs-title function_ invoke__">load_app</span>(current_app);<br>    &#125;<br>    app_manager.<span class="hljs-title function_ invoke__">move_to_next_app</span>();<br>    <span class="hljs-title function_ invoke__">drop</span>(app_manager);<br>    <span class="hljs-comment">// before this we have to drop local variables related to resources manually</span><br>    <span class="hljs-comment">// and release the resources</span><br>    <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123; <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__restore</span>(cx_addr: <span class="hljs-type">usize</span>); &#125;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        __restore(KERNEL_STACK.<span class="hljs-title function_ invoke__">push_context</span>(<br>            TrapContext::<span class="hljs-title function_ invoke__">app_init_context</span>(APP_BASE_ADDRESS, USER_STACK.<span class="hljs-title function_ invoke__">get_sp</span>())<br>        ) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> _ <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>    &#125;<br>    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unreachable in batch::run_current_app!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>push_context</code>çš„è¿”å›å€¼æ˜¯å†…æ ¸æ ˆå‹å…¥Trapä¸Šä¸‹æ–‡ä¹‹åçš„æ ˆé¡¶ï¼Œå®ƒä¼šè¢«ä½œä¸º<code>__restore</code>çš„å‚æ•°ä¼ å…¥</p>
<p>è¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥ç†è§£ä¸ºä½•<code>__restore</code>å‡½æ•°çš„èµ·å§‹éƒ¨åˆ†ä¼šæœ‰<code>mov sp, a0</code>äº†~</p>
<p>è¿™ä½¿å¾—åœ¨<code>__restore</code>å‡½æ•°ä¸­<code>sp</code>ä»ç„¶å¯ä»¥æŒ‡å‘å†…æ ¸æ ˆçš„æ ˆé¡¶ï¼Œè¿™ä¹‹åï¼Œå°±å’Œæ‰§è¡Œä¸€æ¬¡æ™®é€šçš„<code>__restore</code>å‡½æ•°è°ƒç”¨ä¸€æ ·äº†â€¦</p>
<p><code>bootloader</code>å®Œæˆåˆå§‹åŒ–åå°†æ§åˆ¶æƒè½¬äº¤ç»™æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿ</p>
<p>ä¸‹é¢æ˜¯<code>rust_main</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">//! The main module and entrypoint</span><br><span class="hljs-comment">//!</span><br><span class="hljs-comment">//! Various facilities of the kernels are implemented as submodules. The most</span><br><span class="hljs-comment">//! important ones are:</span><br><span class="hljs-comment">//!</span><br><span class="hljs-comment">//! - [`trap`]: Handles all cases of switching from userspace to the kernel</span><br><span class="hljs-comment">//! - [`syscall`]: System call handling and implementation</span><br><span class="hljs-comment">//!</span><br><span class="hljs-comment">//! The operating system also starts in this module. Kernel code starts</span><br><span class="hljs-comment">//! executing from `entry.asm`, after which [`rust_main()`] is called to</span><br><span class="hljs-comment">//! initialize various pieces of functionality. (See its source code for</span><br><span class="hljs-comment">//! details.)</span><br><span class="hljs-comment">//!</span><br><span class="hljs-comment">//! We then call [`batch::run_next_app()`] and for the first time go to</span><br><span class="hljs-comment">//! userspace.</span><br><br><span class="hljs-meta">#![deny(missing_docs)]</span><br><span class="hljs-meta">#![deny(warnings)]</span><br><span class="hljs-meta">#![no_main]</span><br><span class="hljs-meta">#![no_std]</span><br><br><span class="hljs-keyword">use</span> core::arch::global_asm;<br><span class="hljs-keyword">use</span> log::*;<br><br><span class="hljs-meta">#[macro_use]</span><br><span class="hljs-keyword">mod</span> console;<br><span class="hljs-keyword">mod</span> lang_items;<br><span class="hljs-keyword">mod</span> logging;<br><span class="hljs-keyword">mod</span> sbi;<br><span class="hljs-keyword">mod</span> sync;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> syscall;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> batch;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> trap;<br><br>global_asm!(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;entry.asm&quot;</span>));<br>global_asm!(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;link_app.S&quot;</span>));<br><br><span class="hljs-comment">/// clear BSS segment</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">clear_bss</span>() &#123;<br>    <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sbss</span>();<br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ebss</span>(); <br>    &#125;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(sbss <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, ebss <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> - sbss <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>)<br>            .<span class="hljs-title function_ invoke__">fill</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/// the rust entry-point of os</span><br><span class="hljs-meta">#[unsafe(no_mangle)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">rust_main</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">stext</span>(); <span class="hljs-comment">// begin addr of text segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">etext</span>(); <span class="hljs-comment">// end addr of text segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">srodata</span>(); <span class="hljs-comment">// start addr of Read-Only data segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">erodata</span>(); <span class="hljs-comment">// end addr of Read-Only data segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sdata</span>(); <span class="hljs-comment">// start addr of data segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">edata</span>(); <span class="hljs-comment">// end addr of data segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sbss</span>(); <span class="hljs-comment">// start addr of BSS segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ebss</span>(); <span class="hljs-comment">// end addr of BSS segment</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">boot_stack_lower_bound</span>(); <span class="hljs-comment">// stack lower bound</span><br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">boot_stack_top</span>(); <span class="hljs-comment">// stack top</span><br>    &#125;<br>    <span class="hljs-title function_ invoke__">clear_bss</span>();<br>    logging::<span class="hljs-title function_ invoke__">init</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Hello roxy! I am kernel, your friend! Congratulations! You succeed in constructing a batch system!&quot;</span>);<br>    trace!(<br>        <span class="hljs-string">&quot;[kernel] .text [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>,<br>        stext <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, etext <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span><br>    );<br>    debug!(<br>        <span class="hljs-string">&quot;[kernel] .rodata [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>,<br>        srodata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, erodata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span><br>    );<br>    info!(<br>        <span class="hljs-string">&quot;[kernel] .data [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>,<br>        sdata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, edata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span><br>    );<br>    warn!(<br>        <span class="hljs-string">&quot;[kernel] boot_stack top=bottom=&#123;:#x&#125;, lower_bound=&#123;:#x&#125;&quot;</span>,<br>        boot_stack_top <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, boot_stack_lower_bound <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span><br>    );<br>    error!(<span class="hljs-string">&quot;[kernel] .bss [&#123;:#x&#125;, &#123;:#x&#125;)&quot;</span>, sbss <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, ebss <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br><br>    trap::<span class="hljs-title function_ invoke__">init</span>();<br>    batch::<span class="hljs-title function_ invoke__">init</span>();<br>    batch::<span class="hljs-title function_ invoke__">run_next_app</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ“ä½œç³»ç»Ÿä¾æ—§å…ˆæ¸…é›¶<code>.bss</code>æ®µï¼Œæ‰“å°æ—¥å¿—</p>
<p>éšååˆå§‹åŒ–trapå’Œbatch</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// trap init</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>() &#123;<br>    <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        safe <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__alltraps</span>();<br>    &#125;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        stvec::<span class="hljs-title function_ invoke__">write</span>(__alltraps <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, TrapMode::Direct);<br>    &#125;<br>&#125;<br><span class="hljs-comment">// batch init</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>() &#123;<br>    <span class="hljs-title function_ invoke__">print_app_info</span>();<br>&#125;<br><br><span class="hljs-comment">/// print apps info</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_app_info</span>() &#123;<br>    APP_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>().<span class="hljs-title function_ invoke__">print_app_info</span>();<br>&#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_app_info</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;there are &#123;&#125; apps totally!!!&quot;</span>, <span class="hljs-keyword">self</span>.num_app);<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-keyword">self</span>.num_app &#123;<br>            <span class="hljs-built_in">println!</span>(<br>                <span class="hljs-string">&quot;[kernel] app_&#123;&#125; range [&#123;:#x&#125;, &#123;:#x&#125;)!&quot;</span>,<br>                i,<br>                <span class="hljs-keyword">self</span>.app_start[i],<br>                <span class="hljs-keyword">self</span>.app_start[i + <span class="hljs-number">1</span>]<br>            );<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¾¿æ˜¯ä¸Šé¢çš„<code>run_next_app</code></p>
<p>å…ˆ<code>exclusive_access</code>ï¼Œç„¶ååˆ†åˆ«<code>get_current_app</code>ï¼Œ<code>load_app</code>ï¼Œ<code>move_to_next_app</code>ï¼Œ<code>drop</code></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>load_app</code>ä»…å®Œæˆå°†åº”ç”¨ç¨‹åºçš„ä»£ç åŠ è½½åˆ°å¯¹åº”çš„å†…å­˜åœ°å€ï¼Œè¿˜å¹¶æœªçœŸæ­£æ‰§è¡Œ</p>
<p>åœ¨<code>__resotre</code>çš„<code>sret</code>ä¹‹åæ‰ä¼šå¼€å§‹æ‰§è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åº</p>
<p>éšåä¾¿æ˜¯åœ¨<code>hello_world.rs</code>å’Œ<code>power.rs</code>ä¸­æµ‹è¯•ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹:</p>
<p>syscall -&gt; ecall -&gt; trap -&gt; ä¿å­˜å¯„å­˜å™¨ -&gt; trap_handler(kernel) -&gt; æ¢å¤å¯„å­˜å™¨ -&gt; ç»§ç»­æ‰§è¡Œ</p>
<p>å³æµ‹è¯•osèƒ½å¦æ­£ç¡®å¤„ç†<code>trap</code></p>
<p>æœ€åexit(main())ç³»ç»Ÿè°ƒç”¨ä»¥<code>run_next_app</code></p>
<p>ç„¶å<code>store_fault.rs</code>ï¼Œ<code>priv_inst.rs</code>å’Œ<code>priv_csr.rs</code>åˆ™åˆ†åˆ«æµ‹è¯•3ç§ä¸åŒçš„<strong>å¼‚å¸¸</strong>ï¼Œè¿‡ç¨‹:</p>
<p>CPUå¼‚å¸¸ -&gt; è‡ªåŠ¨trap_handler -&gt; kill -&gt; <code>run_next_app</code></p>
<p>å³æµ‹è¯•osèƒ½å¦æ­£ç¡®å¤„ç†<code>exception</code></p>
<p>è¿™æ ·åº”ç”¨ç¨‹åºä¾¿ä¼šä¾æ¬¡æ‰§è¡Œäº†~</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å®¢æœé‡é‡å›°éš¾ï¼Œè§£å†³è®¸å¤šé—®é¢˜ï¼Œç»ˆäºå®ç°äº†<em>æ‰¹å¤„ç†æ“ä½œç³»ç»Ÿ</em>ï¼Œå¹¶ä½¿åº”ç”¨ç¨‹åºä¸osç‰¹æƒçº§åˆ«éš”ç¦»ï¼Œä»¥å¤„ç†trapå’Œexception</p>
<p>è¿™ä¾¿æ˜¯å…¨è¿‡ç¨‹äº†!</p>
<p>æ€»è§ˆ:</p>
<p><img src="/images/66.png" srcset="/img/loading.gif" lazyload alt="panorama"></p>
<p>é¡¹ç›®ç»“æ„:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs css">./os/<span class="hljs-attribute">src</span><br>Rust        <span class="hljs-number">13</span> Files   <span class="hljs-number">372</span> Lines<br>Assembly     <span class="hljs-number">2</span> Files    <span class="hljs-number">58</span> Lines<br><br>â”œâ”€â”€ bootloader<br>â”‚   â””â”€â”€ rustsbi-qemu<span class="hljs-selector-class">.bin</span><br>â”œâ”€â”€ LICENSE<br>â”œâ”€â”€ os<br>â”‚   â”œâ”€â”€ build<span class="hljs-selector-class">.rs</span>(æ–°å¢ : ç”Ÿæˆ link_app.S å°†åº”ç”¨ä½œä¸ºä¸€ä¸ªæ•°æ®æ®µé“¾æ¥åˆ°å†…æ ¸)<br>â”‚   â”œâ”€â”€ Cargo.toml<br>â”‚   â”œâ”€â”€ <span class="hljs-built_in">Makefile</span>(ä¿®æ”¹ : æ„å»ºå†…æ ¸ä¹‹å‰å…ˆæ„å»ºåº”ç”¨)<br>â”‚   â””â”€â”€ src<br>â”‚       â”œâ”€â”€ batch.<span class="hljs-built_in">rs</span>(æ–°å¢ : å®ç°äº†ä¸€ä¸ªç®€å•çš„æ‰¹å¤„ç†ç³»ç»Ÿ)<br>â”‚       â”œâ”€â”€ console.rs<br>â”‚       â”œâ”€â”€ entry.asm<br>â”‚       â”œâ”€â”€ lang_items.rs<br>â”‚       â”œâ”€â”€ link_app.<span class="hljs-built_in">S</span>(æ„å»ºäº§ç‰© ç”± os/build.rs è¾“å‡º)<br>â”‚       â”œâ”€â”€ linker-qemu.ld<br>â”‚       â”œâ”€â”€ main.<span class="hljs-built_in">rs</span>(ä¿®æ”¹ : ä¸»å‡½æ•°ä¸­éœ€è¦åˆå§‹åŒ– Trap å¤„ç†å¹¶åŠ è½½å’Œæ‰§è¡Œåº”ç”¨)<br>â”‚       â”œâ”€â”€ sbi.rs<br>â”‚       â”œâ”€â”€ <span class="hljs-built_in">sync</span>(æ–°å¢ : åŒæ­¥å­æ¨¡å— sync ç›®å‰å”¯ä¸€åŠŸèƒ½æ˜¯æä¾› UPSafeCell )<br>â”‚       â”‚   â”œâ”€â”€ mod.rs<br>â”‚       â”‚   â””â”€â”€ up.<span class="hljs-built_in">rs</span>(åŒ…å« UPSafeCell å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»¥æ›´ Rust çš„æ–¹å¼ä½¿ç”¨å…¨å±€å˜é‡)<br>â”‚       â”œâ”€â”€ <span class="hljs-built_in">syscall</span>(æ–°å¢ : ç³»ç»Ÿè°ƒç”¨å­æ¨¡å— syscall )<br>â”‚       â”‚   â”œâ”€â”€ fs.<span class="hljs-built_in">rs</span>(åŒ…å«æ–‡ä»¶ I/O ç›¸å…³çš„ syscall )<br>â”‚       â”‚   â”œâ”€â”€ mod.<span class="hljs-built_in">rs</span>(æä¾› syscall æ–¹æ³•æ ¹æ® syscall ID è¿›è¡Œåˆ†å‘å¤„ç†)<br>â”‚       â”‚   â””â”€â”€ process.<span class="hljs-built_in">rs</span>(åŒ…å«ä»»åŠ¡å¤„ç†ç›¸å…³çš„ syscall)<br>â”‚       â””â”€â”€ <span class="hljs-built_in">trap</span>(æ–°å¢ : Trap ç›¸å…³å­æ¨¡å— trap )<br>â”‚           â”œâ”€â”€ context.<span class="hljs-built_in">rs</span>(åŒ…å« Trap ä¸Šä¸‹æ–‡ TrapContext )<br>â”‚           â”œâ”€â”€ mod.<span class="hljs-built_in">rs</span>(åŒ…å« Trap å¤„ç†å…¥å£ trap_handler )<br>â”‚           â””â”€â”€ trap.<span class="hljs-built_in">S</span>(åŒ…å« Trap ä¸Šä¸‹æ–‡ä¿å­˜ä¸æ¢å¤çš„æ±‡ç¼–ä»£ç )<br>â”œâ”€â”€ README.md<br>â”œâ”€â”€ rust-toolchain<br>â””â”€â”€ <span class="hljs-built_in">user</span>(æ–°å¢ : åº”ç”¨æµ‹ä¾‹ä¿å­˜åœ¨ user ç›®å½•ä¸‹)<br>   â”œâ”€â”€ Cargo.toml<br>   â”œâ”€â”€ Makefile<br>   â””â”€â”€ src<br>      â”œâ”€â”€ <span class="hljs-built_in">bin</span>(åŸºäºç”¨æˆ·åº“ user_lib å¼€å‘çš„åº”ç”¨ æ¯ä¸ªåº”ç”¨æ”¾åœ¨ä¸€ä¸ªæºæ–‡ä»¶ä¸­)<br>      â”‚   â”œâ”€â”€ <span class="hljs-number">00</span>hello_world.rs<br>      â”‚   â”œâ”€â”€ <span class="hljs-number">01s</span>tore_fault.rs<br>      â”‚   â”œâ”€â”€ <span class="hljs-number">02</span>power.rs<br>      â”‚   â”œâ”€â”€ <span class="hljs-number">03</span>priv_inst.rs<br>      â”‚   â””â”€â”€ <span class="hljs-number">04</span>priv_csr.rs<br>      â”œâ”€â”€ console.rs<br>      â”œâ”€â”€ lang_items.rs<br>      â”œâ”€â”€ lib.<span class="hljs-built_in">rs</span>(ç”¨æˆ·åº“ user_lib )<br>      â”œâ”€â”€ linker.<span class="hljs-built_in">ld</span>(åº”ç”¨çš„é“¾æ¥è„šæœ¬)<br>      â””â”€â”€ syscall.<span class="hljs-built_in">rs</span>(åŒ…å« syscall æ–¹æ³•ç”Ÿæˆå®é™…ç”¨äºç³»ç»Ÿè°ƒç”¨çš„æ±‡ç¼–æŒ‡ä»¤ | å„ä¸ªå…·ä½“çš„ syscall éƒ½æ˜¯é€šè¿‡ syscall æ¥å®ç°çš„)<br></code></pre></td></tr></table></figure>

<p>æœ€åè¾“å‡º:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">RustSBI output</span>]<br>[<span class="hljs-meta">kernel</span>] Hello, world!<br>[<span class="hljs-meta">kernel</span>] num_app = <span class="hljs-number">5</span><br>[<span class="hljs-meta">kernel</span>] app_0 [<span class="hljs-number">0x8020a038</span>, <span class="hljs-number">0x8020af90</span>)<br>[<span class="hljs-meta">kernel</span>] app_1 [<span class="hljs-number">0x8020af90</span>, <span class="hljs-number">0x8020bf80</span>)<br>[<span class="hljs-meta">kernel</span>] app_2 [<span class="hljs-number">0x8020bf80</span>, <span class="hljs-number">0x8020d108</span>)<br>[<span class="hljs-meta">kernel</span>] app_3 [<span class="hljs-number">0x8020d108</span>, <span class="hljs-number">0x8020e0e0</span>)<br>[<span class="hljs-meta">kernel</span>] app_4 [<span class="hljs-number">0x8020e0e0</span>, <span class="hljs-number">0x8020f0b8</span>)<br>[<span class="hljs-meta">kernel</span>] Loading app_0<br>Hello, world!<br>[<span class="hljs-meta">kernel</span>] Application exited <span class="hljs-keyword">with</span> code <span class="hljs-number">0</span><br>[<span class="hljs-meta">kernel</span>] Loading app_1<br>Into Test store_fault, we will insert an invalid store operation...<br>Kernel should kill <span class="hljs-keyword">this</span> application!<br>[<span class="hljs-meta">kernel</span>] PageFault <span class="hljs-keyword">in</span> application, kernel killed it.<br>[<span class="hljs-meta">kernel</span>] Loading app_2<br><span class="hljs-number">3</span>^<span class="hljs-number">10000</span>=<span class="hljs-number">5079</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">20000</span>=<span class="hljs-number">8202</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">30000</span>=<span class="hljs-number">8824</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">40000</span>=<span class="hljs-number">5750</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">50000</span>=<span class="hljs-number">3824</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">60000</span>=<span class="hljs-number">8516</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">70000</span>=<span class="hljs-number">2510</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">80000</span>=<span class="hljs-number">9379</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">90000</span>=<span class="hljs-number">2621</span>(MOD <span class="hljs-number">10007</span>)<br><span class="hljs-number">3</span>^<span class="hljs-number">100000</span>=<span class="hljs-number">2749</span>(MOD <span class="hljs-number">10007</span>)<br>Test power OK!<br>[<span class="hljs-meta">kernel</span>] Application exited <span class="hljs-keyword">with</span> code <span class="hljs-number">0</span><br>[<span class="hljs-meta">kernel</span>] Loading app_3<br>Try to execute privileged instruction <span class="hljs-keyword">in</span> U Mode<br>Kernel should kill <span class="hljs-keyword">this</span> application!<br>[<span class="hljs-meta">kernel</span>] IllegalInstruction <span class="hljs-keyword">in</span> application, kernel killed it.<br>[<span class="hljs-meta">kernel</span>] Loading app_4<br>Try to access privileged CSR <span class="hljs-keyword">in</span> U Mode<br>Kernel should kill <span class="hljs-keyword">this</span> application!<br>[<span class="hljs-meta">kernel</span>] IllegalInstruction <span class="hljs-keyword">in</span> application, kernel killed it.<br>[<span class="hljs-meta">kernel</span>] Panicked at src/batch.rs:<span class="hljs-number">58</span> All applications completed!<br></code></pre></td></tr></table></figure>

<p>æˆåŠŸ!</p>
<hr>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>okå•Šç»ˆäºç»“æŸäº†ï¼Œå†™ä»£ç çš„æ—¶å€™æ¯”è¾ƒå®¹æ˜“ï¼Œä½†æ˜¯æƒ³è¡¨è¾¾å‡ºæ¥æ•´ä¸ªè¿‡ç¨‹è¿˜çœŸæ˜¯ä¸å®¹æ˜“å•Š</p>
<p>å¸Œæœ›æˆ‘èƒ½åšæŒä¸‹å»å§â€¦</p>
<p>æœ€è¿‘pwnä¹Ÿæ‘†äº†ï¼Œåé¢å†æ‹¾èµ·å§â€¦</p>
<p>é©¬ä¸Šå¼€å­¦äº†ï¼Œå¤§ä¸€ä¸‹è¯¾ç¨‹åˆå¤šåˆæ»¡ï¼Œä¸è¿‡ä¾æ—§æ˜¯â€å¥½å¥½ä¸Šè¯¾â€ ğŸ˜ğŸ˜</p>
<p>æœ€åç¥ä½ ç”Ÿæ´»æ„‰å¿«ï¼Œå¤©å¤©å¼€å¿ƒ! ğŸ˜ğŸ˜</p>
<p>æ„Ÿè°¢é˜…è¯»â€¦ ğŸ˜›</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/OS/" class="category-chain-item">OS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/trap/" class="print-no-link">#trap</a>
      
        <a href="/tags/%E5%86%85%E6%A0%B8%E6%A0%88/" class="print-no-link">#å†…æ ¸æ ˆ</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>batch system</div>
      <div>https://roxy5201314.github.io/2026/02/25/batch-system/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>roxy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2026å¹´2æœˆ25æ—¥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>æ›´æ–°äº</div>
          <div>2026å¹´2æœˆ26æ—¥</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2026/02/23/hello-kernel/" title="hello kernel!">
                        <span class="hidden-mobile">hello kernel!</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>roxy</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>QQ</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
